<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Coner</title>
    <link rel="stylesheet" href="styles.css?v=2.3">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="feedback-ui.js"></script>
    <!-- Add jsPDF library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="config.js"></script>
</head>
<body>
    <header>
        <nav class="navbar">
            <div class="logo"><a href="index.html" style="color: #ffffff; text-decoration: none; font-family: 'Poppins', sans-serif;">MamaCare</a></div>
            <button class="menu-toggle" id="menu-toggle">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <ul class="nav-links" id="nav-links">
                <li><a href="index.html">Home</a></li>
                <li><a href="hospitals.html">Hospitals</a></li>
                <li><a href="pharmacy.html">Pharmacy</a></li>
                <li><a href="medical_personnel.html">Healthcare Professionals</a></li>
                <li><a href="medical_records_view.html" class="active">Medical Records</a></li>
                <li><a href="provider_access.html">Healthcare Provider Access</a></li>
            </ul>
        </nav>
        <div class="nav-overlay" id="nav-overlay"></div>
    </header>

    <section class="auth-section">
        <div class="auth-container">
            <div class="auth-header">
                <div class="logo-container">
                    <i class="fas fa-heartbeat"></i>
                </div>
                <h1>Welcome to MamaCare</h1>
                <p class="auth-subtitle">Access your medical records securely</p>
            </div>
            <form id="pinForm" class="auth-form">
                <div class="form-group">
                    <label for="patientPin">Enter your 6-digit PIN</label>
                    <div class="pin-input-container">
                        <input type="password" id="patientPin" name="patientPin" maxlength="6" pattern="\d{6}" placeholder="Enter PIN" required>
                        <button type="button" class="toggle-pin-visibility" onclick="togglePinVisibility()">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                <button type="submit" class="btn-primary btn-block">
                    <i class="fas fa-sign-in-alt"></i> Access Records
                </button>
            </form>
            <p id="pinError" class="error-message" style="display: none;">Invalid PIN. Please try again.</p>
            <div class="auth-footer">
                <p>New to MamaCare?</p>
                <button onclick="navigateToAddPatient()" class="btn-secondary btn-block">
                    <i class="fas fa-user-plus"></i> Register as New Patient
                </button>
            </div>
        </div>
    </section>

    <section class="add-patient" id="addPatientSection" style="display: none;">
        <div class="form-container">
        <h1>Add New Patient</h1>
        <form id="addPatientForm" class="fhir-form">
            <div class="form-section">
                    <h3><i class="fas fa-user"></i> Basic Information</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="first_name">First Name</label>
                            <input type="text" id="first_name" name="first_name" class="form-control" required>
                        </div>

                        

                        <div class="form-group">
                            <label for="middle_name">Middle Name</label>
                            <input type="text" id="middle_name" name="middle_name" class="form-control">
                        </div>

                        <div class="form-group">
                            <label for="last_name">Last Name</label>
                            <input type="text" id="last_name" name="last_name" class="form-control" required>
                        </div>

                        <div class="form-group">
                            <label for="date_of_birth">Date of Birth</label>
                            <input type="date" id="date_of_birth" name="date_of_birth" class="form-control" required>
                        </div>

                        <div class="form-group">
                            <label for="gender">Gender</label>
                            <select id="gender" name="gender" class="form-control" required>
                    <option value="" disabled selected>Select gender</option>
                                <option value="male">Male</option>
                    <option value="female">Female</option>
                                <option value="other">Other</option>
                                <option value="unknown">Unknown</option>
                </select>
                        </div>
                    </div>
            </div>

            <div class="form-section">
                    <h3><i class="fas fa-address-card"></i> Contact Information</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="email">Email</label>
                            <input type="email" id="email" name="email" class="form-control" required>
                        </div>

                        <div class="form-group">
                            <label for="phone">Phone</label>
                            <input type="tel" id="phone" name="phone" class="form-control" required>
                        </div>

                        <div class="form-group full-width">
                            <label for="address_line">Address</label>
                            <input type="text" id="address_line" name="address_line" class="form-control" required>
                        </div>

                        <div class="form-group">
                            <label for="city">City</label>
                            <select id="city" name="city" class="form-control" required>
                                <option value="" disabled selected>Select city</option>
                                <option value="Freetown">Freetown</option>
                                <option value="Bo">Bo</option>
                                <option value="Kenema">Kenema</option>
                                <option value="Makeni">Makeni</option>
                                <option value="Koidu">Koidu</option>
                                <option value="Port Loko">Port Loko</option>
                                <option value="Kabala">Kabala</option>
                                <option value="Kailahun">Kailahun</option>
                                <option value="Kambia">Kambia</option>
                                <option value="Kono">Kono</option>
                                <option value="Pujehun">Pujehun</option>
                                <option value="Tonkolili">Tonkolili</option>
                                <option value="Bonthe">Bonthe</option>
                                <option value="Moyamba">Moyamba</option>
                                <option value="Karene">Karene</option>
                                <option value="Falaba">Falaba</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="state">State/Province</label>
                            <select id="state" name="state" class="form-control" required>
                                <option value="" disabled selected>Select state/province</option>
                                <!-- Provinces -->
                                <optgroup label="Provinces">
                                    <option value="Eastern Province">Eastern Province</option>
                                    <option value="Northern Province">Northern Province</option>
                                    <option value="Southern Province">Southern Province</option>
                                    <option value="Western Area">Western Area</option>
                                </optgroup>
                                <!-- Districts -->
                                <optgroup label="Districts">
                                    <option value="Bo District">Bo District</option>
                                    <option value="Bombali District">Bombali District</option>
                                    <option value="Bonthe District">Bonthe District</option>
                                    <option value="Falaba District">Falaba District</option>
                                    <option value="Kailahun District">Kailahun District</option>
                                    <option value="Kambia District">Kambia District</option>
                                    <option value="Kenema District">Kenema District</option>
                                    <option value="Koinadugu District">Koinadugu District</option>
                                    <option value="Kono District">Kono District</option>
                                    <option value="Moyamba District">Moyamba District</option>
                                    <option value="Port Loko District">Port Loko District</option>
                                    <option value="Pujehun District">Pujehun District</option>
                                    <option value="Tonkolili District">Tonkolili District</option>
                                    <option value="Western Area Rural District">Western Area Rural District</option>
                                    <option value="Western Area Urban District">Western Area Urban District</option>
                                </optgroup>
                                <option value="Other">Other</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="postal_code">Postal Code (Optional)</label>
                            <input type="text" id="postal_code" name="postal_code" class="form-control" placeholder="Not applicable in some regions">
                        </div>

                        <div class="form-group">
                            <label for="country">Country</label>
                            <select id="country" name="country" class="form-control" required>
                                <option value="Sierra Leone" selected>Sierra Leone</option>
                                <option value="Kenya">Kenya</option>
                                <option value="Uganda">Uganda</option>
                                <option value="Tanzania">Tanzania</option>
                                <option value="Rwanda">Rwanda</option>
                                <option value="Burundi">Burundi</option>
                                <option value="South Sudan">South Sudan</option>
                                <option value="Ethiopia">Ethiopia</option>
                                <option value="Somalia">Somalia</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>
            </div>

            <div class="form-section">
                    <h3><i class="fas fa-info-circle"></i> Additional Information</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="marital_status">Marital Status</label>
                            <select id="marital_status" name="marital_status" class="form-control">
                    <option value="" disabled selected>Select status</option>
                    <option value="single">Single</option>
                    <option value="married">Married</option>
                    <option value="divorced">Divorced</option>
                    <option value="widowed">Widowed</option>
                </select>
                        </div>

                        <div class="form-group">
                            <label for="language">Preferred Language</label>
                            <select id="language" name="language" class="form-control">
                                <option value="en" selected>English</option>
                                <option value="sw">Swahili</option>
                                <option value="fr">French</option>
                                <option value="ar">Arabic</option>
                                <option value="other">Other</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="nationality">Nationality</label>
                            <select id="nationality" name="nationality" class="form-control">
                                <option value="Sierra Leonean" selected>Sierra Leonean</option>
                                <option value="Kenyan">Kenyan</option>
                                <option value="Ugandan">Ugandan</option>
                                <option value="Tanzanian">Tanzanian</option>
                                <option value="Rwandan">Rwandan</option>
                                <option value="Burundian">Burundian</option>
                                <option value="South Sudanese">South Sudanese</option>
                                <option value="Ethiopian">Ethiopian</option>
                                <option value="Somali">Somali</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>
            </div>

            <div class="form-section">
                    <h3><i class="fas fa-heartbeat"></i> Medical Information</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="blood_type">Blood Type</label>
                            <select id="blood_type" name="blood_type" class="form-control">
                    <option value="" disabled selected>Select blood type</option>
                    <option value="A+">A+</option>
                    <option value="A-">A-</option>
                    <option value="B+">B+</option>
                    <option value="B-">B-</option>
                    <option value="O+">O+</option>
                    <option value="O-">O-</option>
                    <option value="AB+">AB+</option>
                    <option value="AB-">AB-</option>
                </select>
                        </div>

                        <div class="form-group full-width">
                            <label for="allergies">Allergies</label>
                            <select id="allergies" name="allergies" class="form-control" multiple>
                                <option value="">Select allergies (hold Ctrl/Cmd to select multiple)</option>
                                <option value="penicillin">Penicillin</option>
                                <option value="amoxicillin">Amoxicillin</option>
                                <option value="aspirin">Aspirin</option>
                                <option value="ibuprofen">Ibuprofen</option>
                                <option value="sulfa_drugs">Sulfa Drugs</option>
                                <option value="latex">Latex</option>
                                <option value="peanuts">Peanuts</option>
                                <option value="shellfish">Shellfish</option>
                                <option value="eggs">Eggs</option>
                                <option value="milk">Milk</option>
                                <option value="dust">Dust</option>
                                <option value="pollen">Pollen</option>
                                <option value="pet_dander">Pet Dander</option>
                                <option value="other">Other</option>
                            </select>
                            <small class="form-help">Hold Ctrl (Windows) or Cmd (Mac) to select multiple allergies</small>
                        </div>

                        <div class="form-group full-width">
                            <label for="medications">Current Medications</label>
                            <select id="medications" name="medications" class="form-control" multiple>
                                <option value="">Select medications (hold Ctrl/Cmd to select multiple)</option>
                                <option value="folic_acid">Folic Acid</option>
                                <option value="iron_supplements">Iron Supplements</option>
                                <option value="calcium">Calcium</option>
                                <option value="vitamin_d">Vitamin D</option>
                                <option value="prenatal_vitamins">Prenatal Vitamins</option>
                                <option value="blood_pressure_medication">Blood Pressure Medication</option>
                                <option value="diabetes_medication">Diabetes Medication</option>
                                <option value="thyroid_medication">Thyroid Medication</option>
                                <option value="antidepressants">Antidepressants</option>
                                <option value="pain_medication">Pain Medication</option>
                                <option value="antibiotics">Antibiotics</option>
                                <option value="other">Other</option>
                            </select>
                            <small class="form-help">Hold Ctrl (Windows) or Cmd (Mac) to select multiple medications</small>
                        </div>
                    </div>
                </div>

                <!-- Pregnancy Information -->
                <div id="pregnancySection" class="form-section" style="display: none;">
                    <h3><i class="fas fa-baby"></i> Pregnancy Information</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="pregnancy_status">Pregnancy Status</label>
                            <select id="pregnancy_status" name="pregnancy_status" class="form-control">
                        <option value="not_pregnant">Not Pregnant</option>
                        <option value="pregnant">Pregnant</option>
                                <option value="postpartum">Postpartum</option>
                    </select>
                        </div>

                        <div class="form-group">
                            <label for="previous_pregnancies">Previous Pregnancies</label>
                            <input type="number" id="previous_pregnancies" name="previous_pregnancies" class="form-control" min="0">
                        </div>
                    </div>

                    <div id="pregnancyDetails" class="form-grid" style="display: none;">
                        <div class="form-group">
                            <label for="lmp_date">Last Menstrual Period</label>
                            <input type="date" id="lmp_date" name="lmp_date" class="form-control">
                            </div>

                        <div class="form-group">
                            <label for="due_date">Estimated Due Date</label>
                            <input type="date" id="due_date" name="due_date" class="form-control">
                            </div>

                        <div class="form-group">
                            <label for="multiple_pregnancy">Multiple Pregnancy</label>
                            <select id="multiple_pregnancy" name="multiple_pregnancy" class="form-control">
                                    <option value="no">No</option>
                                    <option value="yes">Yes</option>
                                </select>
                            </div>

                        <div class="form-group">
                            <label for="risk_level">Risk Level</label>
                            <select id="risk_level" name="risk_level" class="form-control">
                                    <option value="low">Low</option>
                                    <option value="medium">Medium</option>
                                    <option value="high">High</option>
                                </select>
                            </div>

                        <div class="form-group full-width">
                            <label for="risk_factors">Risk Factors</label>
                            <select id="risk_factors" name="risk_factors" class="form-control" multiple>
                                    <option value="age">Advanced Maternal Age</option>
                                    <option value="diabetes">Diabetes</option>
                                    <option value="hypertension">Hypertension</option>
                                    <option value="obesity">Obesity</option>
                                    <option value="previous_csection">Previous C-Section</option>
                                    <option value="multiple_pregnancy">Multiple Pregnancy</option>
                                </select>
                            </div>

                        <div class="form-group">
                            <label for="blood_pressure">Blood Pressure</label>
                            <input type="text" id="blood_pressure" name="blood_pressure" class="form-control" placeholder="e.g., 120/80">
                            </div>

                        <div class="form-group">
                            <label for="hemoglobin">Hemoglobin (g/dL)</label>
                            <input type="number" step="0.1" id="hemoglobin" name="hemoglobin" class="form-control">
                            </div>

                        <div class="form-group">
                            <label for="blood_sugar">Blood Sugar (mg/dL)</label>
                            <input type="number" id="blood_sugar" name="blood_sugar" class="form-control">
                            </div>

                        <div class="form-group">
                            <label for="weight">Weight (kg)</label>
                            <input type="number" step="0.1" id="weight" name="weight" class="form-control">
                            </div>

                        <div class="form-group">
                            <label for="prenatal_vitamins">Taking Prenatal Vitamins</label>
                            <select id="prenatal_vitamins" name="prenatal_vitamins" class="form-control">
                                    <option value="yes">Yes</option>
                                    <option value="no">No</option>
                                </select>
                            </div>

                        <div class="form-group full-width">
                            <label for="pregnancy_complications">Pregnancy Complications</label>
                            <select id="pregnancy_complications" name="pregnancy_complications" class="form-control" multiple>
                                <option value="">Select complications (hold Ctrl/Cmd to select multiple)</option>
                                <option value="gestational_diabetes">Gestational Diabetes</option>
                                <option value="preeclampsia">Preeclampsia</option>
                                <option value="eclampsia">Eclampsia</option>
                                <option value="placenta_previa">Placenta Previa</option>
                                <option value="placental_abruption">Placental Abruption</option>
                                <option value="preterm_labor">Preterm Labor</option>
                                <option value="anemia">Anemia</option>
                                <option value="hypertension">Hypertension</option>
                                <option value="hyperemesis_gravidarum">Hyperemesis Gravidarum</option>
                                <option value="oligohydramnios">Oligohydramnios</option>
                                <option value="polyhydramnios">Polyhydramnios</option>
                                <option value="intrauterine_growth_restriction">Intrauterine Growth Restriction</option>
                                <option value="other">Other</option>
                            </select>
                            <small class="form-help">Hold Ctrl (Windows) or Cmd (Mac) to select multiple complications</small>
                            </div>

                        <div class="form-group">
                            <label for="emergency_hospital">Preferred Emergency Hospital</label>
                            <input type="text" id="emergency_hospital" name="emergency_hospital" class="form-control">
                            </div>

                        <div class="form-group full-width">
                            <label for="birth_plan">Birth Plan</label>
                            <textarea id="birth_plan" name="birth_plan" class="form-control" rows="4"></textarea>
                    </div>
                </div>
            </div>

            <div class="form-section">
                    <h3><i class="fas fa-phone-alt"></i> Emergency Contact</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="emergency_contact_name">Contact Name</label>
                            <input type="text" id="emergency_contact_name" name="emergency_contact_name" class="form-control">
                        </div>

                        <div class="form-group">
                            <label for="emergency_contact_phone">Contact Phone</label>
                            <input type="tel" id="emergency_contact_phone" name="emergency_contact_phone" class="form-control">
                        </div>

                        <div class="form-group">
                            <label for="emergency_contact_relationship">Relationship</label>
                            <select id="emergency_contact_relationship" name="emergency_contact_relationship" class="form-control">
                                <option value="" disabled selected>Select relationship</option>
                                <option value="spouse">Spouse</option>
                                <option value="parent">Parent</option>
                                <option value="sibling">Sibling</option>
                                <option value="child">Child</option>
                                <option value="friend">Friend</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>
            </div>

                <div class="form-actions">
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-user-plus"></i> Register Patient
                    </button>
                </div>
        </form>
        </div>
    </section>

    <style>
        .form-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .form-section {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .form-section h3 {
            color: #2c3e50;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-section h3 i {
            color: #3498db;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #2c3e50;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        select.form-control {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%232c3e50' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14L2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            padding-right: 2.5rem;
        }

        textarea.form-control {
            resize: vertical;
            min-height: 100px;
        }

        .form-actions {
            text-align: center;
            margin-top: 2rem;
        }

        .btn-primary {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 5px;
            font-size: 1.1rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: background-color 0.3s ease;
        }

        .btn-primary:hover {
            background-color: #2980b9;
        }

        @media (max-width: 768px) {
            .form-container {
                padding: 1rem;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>

    <section class="medical-records" id="medicalRecords" style="display: none;">
        <div class="records-header-pro">
            <i class="fas fa-file-medical"></i>
            <h1>Patient Medical Records</h1>
        </div>

        <!-- Patient Overview -->
        <div class="patient-profile">
            <div class="profile-header">
                <div class="profile-avatar">
                    <i class="fas fa-user-circle"></i>
                </div>
                <div class="profile-info">
                    <h2 id="patientNameDisplay"></h2>
                    <p class="profile-subtitle">Patient Medical Profile</p>
                    <div class="profile-ids">
                        <span class="id-badge"><i class="fas fa-id-card"></i> ID: <span id="patientIdDisplay"></span></span>
                        <span class="id-badge"><i class="fas fa-heartbeat"></i> FHIR: <span id="patientFhirIdDisplay"></span></span>
                    </div>
                </div>
                <div class="profile-actions">
                    <button class="btn-edit" type="button"><i class="fas fa-edit"></i> Edit</button>
                    <button id="saveProfileBtn" class="btn-primary" style="display: none;" type="button"><i class="fas fa-save"></i> Save</button>
                    <button class="btn-logout" type="button"><i class="fas fa-sign-out-alt"></i> Logout</button>
                </div>
            </div>

            <!-- Overview Stats Cards -->
            <div class="overview-stats">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="totalRecordsCount">0</h3>
                        <p>Total Records</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-calendar-alt"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="lastVisitDate">N/A</h3>
                        <p>Last Visit</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-baby"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="pregnancyStatus">N/A</h3>
                        <p>Pregnancy Status</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-heartbeat"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="bloodTypeDisplay">N/A</h3>
                        <p>Blood Type</p>
                    </div>
                </div>
            </div>

            <!-- Profile Tabs -->
            <div class="profile-tabs">
                <button class="tab-btn active" data-tab="personal">
                    <i class="fas fa-user"></i> Personal Info
                </button>
                <button class="tab-btn" data-tab="medical">
                    <i class="fas fa-heartbeat"></i> Medical Info
                </button>
                <button class="tab-btn" data-tab="pregnancy">
                    <i class="fas fa-baby"></i> Pregnancy
                </button>
                <button class="tab-btn" data-tab="records">
                    <i class="fas fa-file-medical"></i> Records
                </button>
            </div>

            <!-- Tab Content -->
            <div class="tab-content">
                <!-- Personal Info Tab -->
                <div class="tab-pane active" id="personal-tab">
                    <div class="tab-section">
                        <h3><i class="fas fa-user"></i> Basic Information</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <label>Full Name</label>
                            <span id="patientNameDisplay"></span>
                            <input type="text" id="patientNameInput" style="display: none;" class="input-field" />
                        </div>
                        <div class="info-item">
                            <label>Date of Birth</label>
                            <span id="patientDobDisplay"></span>
                            <input type="text" id="patientDobInput" style="display: none;" class="input-field" />
                        </div>
                        <div class="info-item">
                            <label>Gender</label>
                            <span id="patientGenderDisplay"></span>
                            <input type="text" id="patientGenderInput" style="display: none;" class="input-field" />
                        </div>
                        <div class="info-item">
                            <label>Blood Type</label>
                            <span id="patientBloodTypeDisplay"></span>
                            <input type="text" id="patientBloodTypeInput" style="display: none;" class="input-field" />
                        </div>
                        <div class="info-item">
                            <label>Marital Status</label>
                            <span id="patientMaritalStatusDisplay"></span>
                            <input type="text" id="patientMaritalStatusInput" style="display: none;" class="input-field" />
                        </div>
                        <div class="info-item">
                            <label>Language</label>
                            <span id="patientLanguageDisplay"></span>
                            <input type="text" id="patientLanguageInput" style="display: none;" class="input-field" />
                        </div>
                        <div class="info-item">
                            <label>Nationality</label>
                            <span id="patientNationalityDisplay"></span>
                            <input type="text" id="patientNationalityInput" style="display: none;"  class="input-field" />
                        </div>
                    </div>
                </div>

                    <div class="tab-section">
                        <h3><i class="fas fa-address-card"></i> Contact Information</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <label>Email</label>
                            <span id="patientEmailDisplay"></span>
                            <input type="email" id="patientEmailInput" style="display: none;" class="input-field" />
                        </div>
                        <div class="info-item">
                            <label>Phone</label>
                            <span id="patientPhoneDisplay"></span>
                            <input type="tel" id="patientPhoneInput" style="display: none;" class="input-field" />
                        </div>
                        <div class="info-item full-width">
                            <label>Address</label>
                            <span id="patientAddressDisplay"></span>
                            <input type="text" id="patientAddressInput" style="display: none;" class="input-field" />
                        </div>
                    </div>
                </div>

                    <div class="tab-section">
                        <h3><i class="fas fa-phone"></i> Emergency Contact</h3>
                        <div class="info-grid">
                            <div class="info-item">
                                <label>Contact Name</label>
                                <span id="emergencyContactNameDisplay"></span>
                                <input type="text" id="emergencyContactNameInput" style="display: none;" class="input-field" />
                    </div>
                            <div class="info-item">
                                <label>Contact Phone</label>
                                <span id="emergencyContactPhoneDisplay"></span>
                                <input type="tel" id="emergencyContactPhoneInput" style="display: none;" class="input-field" />
                            </div>
                            <div class="info-item">
                                <label>Relationship</label>
                                <span id="emergencyContactRelationshipDisplay"></span>
                                <input type="text" id="emergencyContactRelationshipInput" style="display: none;" class="input-field" />
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Medical Info Tab -->
                <div class="tab-pane" id="medical-tab">
                    <div class="tab-section">
                        <h3><i class="fas fa-heartbeat"></i> Medical Information</h3>
                    <div class="info-grid">
                        <div class="info-item full-width">
                            <label>Allergies</label>
                            <span id="patientAllergiesDisplay"></span>
                            <textarea id="patientAllergiesInput" style="display: none;" class="input-field"></textarea>
                        </div>
                        <div class="info-item full-width">
                            <label>Current Medications</label>
                            <span id="patientMedicationsDisplay"></span>
                            <textarea id="patientMedicationsInput" style="display: none;" class="input-field"></textarea>
                        </div>
                        </div>
                    </div>
                </div>

                <!-- Pregnancy Tab -->
                <div class="tab-pane" id="pregnancy-tab">
                    <div class="tab-section">
                        <h3><i class="fas fa-baby"></i> Pregnancy Information</h3>
                        <div class="info-grid">
                            <div class="info-item">
                            <label>Pregnancy Status</label>
                            <span id="patientPregnancyStatusDisplay"></span>
                            <select id="patientPregnancyStatusInput" style="display: none;" class="input-field">
                                <option value="not_pregnant">Not Pregnant</option>
                                <option value="pregnant">Pregnant</option>
                            </select>
                        </div>
                            <div class="info-item">
                            <label>Estimated Due Date</label>
                            <span id="patientDueDateDisplay" onclick="confirmPregnancyFieldEdit('patientDueDate')" style="cursor: pointer; color: #dc3545; text-decoration: underline; font-weight: 600;" title="Click to edit"></span>
                            <input type="date" id="patientDueDateInput" style="display: none;" class="input-field" />
                        </div>
                            <div class="info-item">
                            <label>Gestational Age (weeks)</label>
                            <span id="patientGestationalAgeDisplay" onclick="confirmPregnancyFieldEdit('patientGestationalAge')" style="cursor: pointer; color: #dc3545; text-decoration: underline; font-weight: 600;" title="Click to edit"></span>
                            <input type="number" id="patientGestationalAgeInput" min="0" max="40" step="1" style="display: none;" class="input-field" />
                        </div>
                            <div class="info-item full-width">
                            <label>Pregnancy Complications</label>
                            <span id="patientPregnancyComplicationsDisplay"></span>
                            <textarea id="patientPregnancyComplicationsInput" style="display: none;" class="input-field"></textarea>
                        </div>
                    </div>
                </div>

                    <div class="tab-section" id="pregnancyProfileSection" style="display: none;">
                        <h3><i class="fas fa-baby"></i> Detailed Pregnancy Information</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <label>Pregnancy Status</label>
                            <span id="pregnancyStatusDisplay"></span>
                            <select id="pregnancyStatusInput" style="display: none;" class="input-field">
                                <option value="not_pregnant">Not Pregnant</option>
                                <option value="pregnant">Pregnant</option>
                                <option value="postpartum">Postpartum</option>
                            </select>
                        </div>

                        <div class="info-item">
                            <label>Previous Pregnancies</label>
                            <span id="previousPregnanciesDisplay"></span>
                            <input type="number" id="previousPregnanciesInput" style="display: none;" class="input-field" min="0" />
                        </div>

                        <div class="info-item">
                            <label>Last Menstrual Period</label>
                            <span id="lmpDateDisplay" onclick="confirmPregnancyFieldEdit('lmpDate')" style="cursor: pointer; color: #dc3545; text-decoration: underline; font-weight: 600;" title="Click to edit"></span>
                            <input type="date" id="lmpDateInput" style="display: none;" class="input-field" />
                        </div>

                        <div class="info-item">
                            <label>Estimated Due Date</label>
                            <span id="dueDateDisplay" onclick="confirmPregnancyFieldEdit('dueDate')" style="cursor: pointer; color: #dc3545; text-decoration: underline; font-weight: 600;" title="Click to edit"></span>
                            <input type="date" id="dueDateInput" style="display: none;" class="input-field" />
                        </div>

                        <div class="info-item">
                            <label>Gestational Age (weeks)</label>
                            <span id="gestationalAgeDisplay" onclick="confirmPregnancyFieldEdit('gestationalAge')" style="cursor: pointer; color: #dc3545; text-decoration: underline; font-weight: 600;" title="Click to edit"></span>
                            <input type="number" id="gestationalAgeInput" style="display: none;" class="input-field" min="0" max="45" />
                        </div>

                        <div class="info-item">
                            <label>Multiple Pregnancy</label>
                            <span id="multiplePregnancyDisplay"></span>
                            <select id="multiplePregnancyInput" style="display: none;" class="input-field">
                                <option value="no">No</option>
                                <option value="twins">Twins</option>
                                <option value="triplets">Triplets or more</option>
                            </select>
                        </div>

                        <!-- Risk Assessment -->
                        <div class="info-item">
                            <label>Risk Level</label>
                            <span id="riskLevelDisplay"></span>
                            <select id="riskLevelInput" style="display: none;" class="input-field">
                                <option value="low">Low Risk</option>
                                <option value="medium">Medium Risk</option>
                                <option value="high">High Risk</option>
                            </select>
                        </div>

                        <div class="info-item full-width">
                            <label>Risk Factors</label>
                            <span id="riskFactorsDisplay"></span>
                            <select id="riskFactorsInput" style="display: none;" class="input-field" multiple>
                                <option value="hypertension">Hypertension</option>
                                <option value="diabetes">Diabetes</option>
                                <option value="anemia">Anemia</option>
                                <option value="previous_csection">Previous C-Section</option>
                                <option value="heart_disease">Heart Disease</option>
                                <option value="obesity">Obesity</option>
                                <option value="advanced_age">Advanced Maternal Age (≥35)</option>
                                <option value="substance_use">Substance Use</option>
                                <option value="multiple_pregnancy">Multiple Pregnancy</option>
                            </select>
                        </div>

                        <!-- Vital Signs -->
                        <div class="info-item">
                            <label>Blood Pressure</label>
                            <span id="bloodPressureDisplay"></span>
                            <input type="text" id="bloodPressureInput" style="display: none;" class="input-field" placeholder="e.g., 120/80" />
                        </div>

                        <div class="info-item">
                            <label>Hemoglobin Level (g/dL)</label>
                            <span id="hemoglobinDisplay"></span>
                            <input type="number" id="hemoglobinInput" style="display: none;" class="input-field" step="0.1" />
                        </div>

                        <div class="info-item">
                            <label>Blood Sugar (mg/dL)</label>
                            <span id="bloodSugarDisplay"></span>
                            <input type="number" id="bloodSugarInput" style="display: none;" class="input-field" step="0.1" />
                        </div>

                        <div class="info-item">
                            <label>Weight (kg)</label>
                            <span id="weightDisplay"></span>
                            <input type="number" id="weightInput" style="display: none;" class="input-field" step="0.1" />
                        </div>

                        <!-- Prenatal Care -->
                        <div class="info-item full-width">
                            <label>Prenatal Vitamins/Supplements</label>
                            <span id="prenatalVitaminsDisplay"></span>
                            <textarea id="prenatalVitaminsInput" style="display: none;" class="input-field"></textarea>
                        </div>

                        <!-- Complications and Emergency Plan -->
                        <div class="info-item full-width">
                            <label>Current Complications</label>
                            <span id="pregnancyComplicationsDisplay"></span>
                            <textarea id="pregnancyComplicationsInput" style="display: none;" class="input-field"></textarea>
                        </div>

                        <div class="info-item full-width">
                            <label>Emergency Hospital</label>
                            <span id="emergencyHospitalDisplay"></span>
                            <input type="text" id="emergencyHospitalInput" style="display: none;" class="input-field" />
                        </div>

                        <div class="info-item full-width">
                            <label>Birth Plan</label>
                            <span id="birthPlanDisplay"></span>
                            <textarea id="birthPlanInput" style="display: none;" class="input-field"></textarea>
                    </div>
                </div>
            </div>
        </div>

                <!-- Records Tab -->
                <div class="tab-pane" id="records-tab">
                    <div class="tab-section">
                        <h3><i class="fas fa-file-medical"></i> Medical Records</h3>
            <div class="records-list">
                <div class="search-container">
                    <div class="search-input-group">
                    <input type="text" id="searchInput" placeholder="Search records..." class="search-input">
                        <button type="button" id="clearSearchBtn" class="clear-search-btn" style="display: none;" onclick="clearSearch()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <select id="searchField" class="search-field">
                        <option value="all">All Fields</option>
                        <option value="date">Date</option>
                        <option value="diagnosis">Diagnosis</option>
                        <option value="treatment">Treatment</option>
                        <option value="medication">Medication</option>
                        <option value="doctor">Doctor</option>
                        <option value="hospital">Hospital</option>
                    </select>
                    <button onclick="downloadSelectedRecords()" class="btn-download" id="bulkDownloadBtn" style="display: none;">
                        Download Selected
                    </button>
                </div>
                <div class="table-container">
                    <table class="records-table">
                        <thead>
                            <tr>
                                <th class="checkbox-header" title="Select All Records">
                                    <input type="checkbox" id="selectAllRecords" onchange="toggleAllRecords()">
                                </th>
                                <th class="sortable" onclick="sortTable(1, 'date')" title="Click to sort by date">
                                    <i class="fas fa-calendar-alt"></i> Date
                                </th>
                                <th class="sortable" onclick="sortTable(2, 'diagnosis')" title="Click to sort by diagnosis">
                                    <i class="fas fa-stethoscope"></i> Diagnosis
                                </th>
                                <th class="sortable" onclick="sortTable(3, 'treatment')" title="Click to sort by treatment">
                                    <i class="fas fa-notes-medical"></i> Treatment
                                </th>
                                <th class="sortable" onclick="sortTable(4, 'medication')" title="Click to sort by medication">
                                    <i class="fas fa-pills"></i> Medication
                                </th>
                                <th class="sortable" onclick="sortTable(5, 'doctor')" title="Click to sort by doctor">
                                    <i class="fas fa-user-md"></i> Doctor
                                </th>
                                <th class="sortable" onclick="sortTable(6, 'hospital')" title="Click to sort by hospital">
                                    <i class="fas fa-hospital"></i> Hospital
                                </th>
                                <th title="Record Actions" class="actions-header">
                                    <i class="fas fa-cogs"></i> Actions
                                </th>
                            </tr>
                        </thead>
                        <tbody id="recordsTableBody">
                            <!-- Medical records will be dynamically populated here -->
                        </tbody>

                    </table>
                </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add New Record Section -->
        <div class="record-container">
            <div class="add-record">
                <div class="section-header">
                    <i class="fas fa-plus-circle"></i>
                <h2>Add New Record</h2>
                </div>
                <form id="addRecordForm" class="modern-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="date">
                                <i class="fas fa-calendar-alt"></i>
                                Date
                            </label>
                            <input type="date" id="date" name="date" class="form-control" required>
                        </div>

                        <div class="form-group">
                            <label for="doctor">
                                <i class="fas fa-user-md"></i>
                                Doctor's Name
                            </label>
                            <input type="text" id="doctor" name="doctor" class="form-control" placeholder="Enter doctor's name" required>
                        </div>

                        <div class="form-group">
                            <label for="hospital">
                                <i class="fas fa-hospital"></i>
                                Hospital
                            </label>
                            <input type="text" id="hospital" name="hospital" class="form-control" placeholder="Enter hospital name" required>
                        </div>

                        <div class="form-group">
                            <label for="diagnosis">
                                <i class="fas fa-stethoscope"></i>
                                Diagnosis
                            </label>
                            <textarea id="diagnosis" name="diagnosis" class="form-control compact" placeholder="Enter diagnosis..." required></textarea>
                        </div>

                        <div class="form-group">
                            <label for="treatment">
                                <i class="fas fa-notes-medical"></i>
                                Treatment
                            </label>
                            <textarea id="treatment" name="treatment" class="form-control compact" placeholder="Enter treatment..." required></textarea>
                        </div>

                        <div class="form-group">
                            <label for="medication">
                                <i class="fas fa-pills"></i>
                                Medication
                            </label>
                            <textarea id="medication" name="medication" class="form-control compact" placeholder="Enter medication..." required></textarea>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn-primary">
                            <i class="fas fa-plus"></i>
                            Add Record
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </section>

    <style>
        .fhir-form {
            max-width: 800px;
            margin: 0 auto;
        }

        .form-section {
            background: #f8f9fa;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
        }

        .form-section h3 {
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .patient-profile {
            background: #fff;
            border-radius: 20px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
            margin: 2rem auto;
            max-width: 1400px;
            overflow: hidden;
            width: 100%;
            box-sizing: border-box;
        }

        .profile-header {
            background: linear-gradient(135deg, #4158D0 0%, #C850C0 46%, #FFCC70 100%);
            color: white;
            padding: 2rem;
            position: relative;
            border-bottom: 4px solid rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            gap: 2rem;
            width: 100%;
            box-sizing: border-box;
        }

        .profile-avatar {
            flex-shrink: 0;
        }

        .profile-avatar i {
            font-size: 4rem;
            opacity: 0.9;
        }

        .profile-info {
            flex: 1;
        }

        .profile-info h2 {
            margin: 0 0 0.5rem 0;
            font-size: 1.8rem;
            font-weight: 600;
        }

        .profile-subtitle {
            margin: 0 0 1rem 0;
            opacity: 0.9;
            font-size: 1rem;
        }

        .profile-ids {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .id-badge {
            background: rgba(255,255,255,0.2);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
        }

        .id-badge i {
            margin-right: 0.5rem;
        }

        .profile-actions {
            display: flex;
            gap: 1rem;
            flex-shrink: 0;
            position: relative;
            z-index: 50;
            pointer-events: auto;
        }

        .btn-edit, .btn-logout {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            position: relative;
            z-index: 100;
            pointer-events: auto;
            user-select: none;
        }

        .btn-edit {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .btn-edit:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .btn-logout {
            background: rgba(220, 53, 69, 0.8);
            color: white;
        }

        .btn-logout:hover {
            background: rgba(220, 53, 69, 1);
            transform: translateY(-2px);
        }

        /* Mobile responsive improvements for profile section */
        @media (max-width: 768px) {
            .profile-header {
                flex-direction: column;
                text-align: center;
                padding: 1.5rem 1rem;
                gap: 1rem;
            }

            .profile-avatar i {
                font-size: 3rem;
            }

            .profile-info h2 {
                font-size: 1.5rem;
                margin-bottom: 0.25rem;
            }

            .profile-subtitle {
                font-size: 0.9rem;
                margin-bottom: 0.75rem;
            }

            .profile-ids {
                justify-content: center;
                gap: 0.5rem;
            }

            .id-badge {
                padding: 0.4rem 0.8rem;
                font-size: 0.8rem;
            }

            .profile-actions {
                width: 100%;
                justify-content: center;
                gap: 0.75rem;
                flex-wrap: wrap;
            }

            .btn-edit, .btn-logout {
                padding: 0.6rem 1.2rem;
                font-size: 0.85rem;
                min-width: 100px;
            }
        }

        /* Enhanced Contrast Improvements */
        .info-item span, .info-item label, .tab-section h3, .section-header h3 {
            color: #1a202c !important;
        }
        
        /* Ensure all content boxes are white */
        .profile-content, .tab-content, .tab-pane, .tab-section, .info-item, .profile-section {
            background: #ffffff !important;
        }
        
        /* Ensure form sections are also white */
        .form-section {
            background: #ffffff !important;
        }
        
        /* Critical pregnancy fields styling */
        .critical-pregnancy-field {
            color: #dc3545 !important;
            font-weight: 600 !important;
            text-decoration: underline !important;
        }
        
        .critical-pregnancy-field:hover {
            color: #c82333 !important;
            background-color: #fff5f5 !important;
            padding: 2px 4px !important;
            border-radius: 4px !important;
        }
        
        .info-item label {
            font-weight: 700 !important;
        }
        
        .info-item span {
            font-weight: 500 !important;
        }
        
        .tab-btn {
            color: #1a202c !important;
            font-weight: 600 !important;
        }
        
        .search-input, .search-field, .input-field {
            color: #1a202c !important;
        }
        
        .clear-search-btn {
            color: #1a202c !important;
        }
        
        .clear-search-btn:hover {
            color: #000000 !important;
        }
        
        /* Table content contrast */
        .records-table td {
            color: #1a202c !important;
            font-weight: 500 !important;
        }
        
        .records-table th {
            color: #ffffff !important;
            font-weight: 700 !important;
        }

        @media (max-width: 480px) {
            .profile-header {
                padding: 1rem 0.75rem;
            }

            .profile-info h2 {
                font-size: 1.3rem;
            }

            .profile-subtitle {
                font-size: 0.85rem;
            }

            .profile-actions {
                flex-direction: column;
                width: 100%;
                gap: 0.5rem;
            }

            .btn-edit, .btn-logout {
                width: 100%;
                justify-content: center;
                padding: 0.75rem 1rem;
            }
        }

        /* Overview Stats */
        .overview-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            padding: 2rem;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 1px solid rgba(0,0,0,0.05);
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            flex-shrink: 0;
        }

        .stat-content h3 {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .stat-content p {
            margin: 0.25rem 0 0 0;
            color: #6c757d;
            font-size: 0.8rem;
        }

        /* Mobile responsive styles for overview stats */
        @media (max-width: 768px) {
            .overview-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
                padding: 1.5rem;
            }

            .stat-card {
                padding: 1rem;
                gap: 0.75rem;
            }

            .stat-icon {
                width: 40px;
                height: 40px;
                font-size: 1.2rem;
            }

            .stat-content h3 {
                font-size: 1rem;
            }

            .stat-content p {
                font-size: 0.75rem;
            }
        }

        @media (max-width: 480px) {
            .overview-stats {
                grid-template-columns: 1fr;
                gap: 0.75rem;
                padding: 1rem;
            }

            .stat-card {
                padding: 0.75rem;
                gap: 0.5rem;
            }

            .stat-icon {
                width: 35px;
                height: 35px;
                font-size: 1rem;
            }

            .stat-content h3 {
                font-size: 0.9rem;
            }

            .stat-content p {
                font-size: 0.7rem;
            }

            /* Mobile optimization for medical records */
            .profile-header {
                padding: 0.5rem;
            }

            .patient-basic-info h2 {
                font-size: 1.4rem;
            }

            .patient-ids {
                flex-direction: column;
                gap: 0.25rem;
                padding: 0.25rem;
            }

            .profile-content {
                padding: 0.25rem;
                gap: 0.5rem;
            }

            .info-grid {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }

            .profile-section {
                padding: 0.5rem;
                margin: 0;
            }

            .tab-pane {
                padding: 0.5rem;
            }

            .tab-section {
                margin-bottom: 0.5rem;
            }

            .info-item {
                padding: 0.75rem;
                margin: 0;
            }

            .search-container {
                padding: 0.75rem;
                margin-bottom: 0.5rem;
            }

            .records-list {
                padding: 0;
                margin-top: 0.5rem;
            }

            .table-container {
                margin-top: 0.5rem;
            }

            .tab-btn {
                padding: 0.75rem 1rem;
                font-size: 0.9rem;
            }

            .section-header h3 {
                font-size: 1.1rem;
            }

            .info-item label {
                font-size: 0.8rem;
            }

            .info-item span {
                font-size: 0.9rem;
            }

            .form-section {
                padding: 1rem;
                margin-bottom: 1rem;
            }

            .form-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
        }

        /* Profile Tabs */
        .profile-tabs {
            display: flex;
            background: white;
            border-bottom: 1px solid #e9ecef;
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .profile-tabs::-webkit-scrollbar {
            display: none;
        }

        .tab-btn {
            padding: 1rem 1.5rem;
            border: none;
            background: #ffffff;
            color: #2c3e50;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            border-bottom: 3px solid transparent;
            position: relative;
            border-radius: 8px 8px 0 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .tab-btn:hover {
            color: #4158D0;
            background: #ffffff;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(65, 88, 208, 0.1);
        }

        .tab-btn.active {
            color: #4158D0;
            border-bottom-color: #4158D0;
            background: #ffffff;
            box-shadow: 0 4px 12px rgba(65, 88, 208, 0.15);
            transform: translateY(-1px);
        }

        .tab-btn i {
            font-size: 1rem;
        }

        /* Tab Content */
        .tab-content {
            background: #ffffff;
            border-radius: 0 12px 12px 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .tab-pane {
            display: none;
            padding: 2rem;
        }

        .tab-pane.active {
            display: block;
        }

        .tab-section {
            margin-bottom: 2rem;
        }

        .tab-section:last-child {
            margin-bottom: 0;
        }

        .tab-section h3 {
            color: #1a202c;
            margin-bottom: 1.5rem;
            font-size: 1.3rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .tab-section h3 i {
            color: #4158D0;
        }

        .profile-content {
            display: grid;
            gap: 2rem;
            padding: 2rem;
            width: 100%;
            box-sizing: border-box;
        }

        .profile-section {
            background: #ffffff;
            padding: 2rem;
            border-radius: 16px;
            transition: transform 0.3s, box-shadow 0.3s;
            border: 1px solid rgba(0,0,0,0.05);
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            width: 100%;
            box-sizing: border-box;
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .section-header i {
            color: #4158D0;
            font-size: 1.2rem;
        }

        .section-header h3 {
            margin: 0;
            color: #1a202c;
            font-size: 1.3rem;
            font-weight: 700;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            width: 100%;
            box-sizing: border-box;
        }

        .info-item {
            background: #ffffff;
            padding: 1.2rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border: 1px solid rgba(65, 88, 208, 0.1);
            width: 100%;
            box-sizing: border-box;
            transition: all 0.3s ease;
        }

        .info-item.full-width {
            grid-column: 1 / -1;
        }

        .info-item label {
            display: block;
            font-weight: 700;
            color: #1a202c;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .info-item span {
            color: #1a202c;
            font-size: 1rem;
            font-weight: 500;
        }

        .input-field {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            color: #1a202c;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
        }

        .input-field:focus {
            outline: none;
            border-color: #4158D0;
            box-shadow: 0 0 0 2px rgba(65, 88, 208, 0.1);
        }

        .records-list {
            margin-top: 2rem;
            width: 100%;
            box-sizing: border-box;
            position: relative;
            padding: 0 1rem;
        }

        .search-container {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            align-items: center;
            flex-wrap: wrap;
            background: white;
            padding: 1.25rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border: 1px solid #e9ecef;
            position: relative;
        }

        .search-input-group {
            position: relative;
            flex: 1;
            min-width: 200px;
        }

        .search-input {
            width: 100%;
            padding: 0.75rem;
            padding-right: 2.5rem;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            color: #1a202c;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
        }

        .search-input:focus {
            outline: none;
            border-color: #4158D0;
            box-shadow: 0 0 0 3px rgba(65, 88, 208, 0.1);
        }

        .clear-search-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #2c3e50;
            cursor: pointer;
            padding: 4px;
            border-radius: 50%;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
        }

        .clear-search-btn:hover {
            background: #e9ecef;
            color: #1a202c;
        }

        .clear-search-btn:active {
            transform: translateY(-50%) scale(0.95);
        }

        .search-field {
            padding: 0.75rem;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            background: white;
            color: #1a202c;
            min-width: 150px;
            transition: border-color 0.3s ease;
            flex-shrink: 0;
        }

        .search-field:focus {
            outline: none;
            border-color: #4158D0;
            box-shadow: 0 0 0 3px rgba(65, 88, 208, 0.1);
        }

        .table-container {
            overflow-x: auto;
            width: 100%;
            box-sizing: border-box;
            margin-top: 3.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
            background: white;
            -webkit-overflow-scrolling: touch;
        }

        /* Ensure table is always fully visible */
        .table-container table {
            margin: 0;
            border-collapse: separate;
            border-spacing: 0;
            width: 100%;
        }



        /* Add visual indicator for horizontal scroll on mobile */
        @media (max-width: 768px) {
            .table-container::after {
                content: '← Scroll →';
                position: absolute;
                bottom: -25px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(65, 88, 208, 0.9);
                color: white;
                padding: 0.25rem 0.75rem;
                border-radius: 12px;
                font-size: 0.75rem;
                font-weight: 600;
                z-index: 5;
                pointer-events: none;
            }
        }

        @media (max-width: 768px) {
            .table-container {
                margin-top: 1rem;
            }
        }

        @media (max-width: 576px) {
            .table-container {
                margin-top: 0.75rem;
            }
        }

        @media (max-width: 480px) {
            .table-container {
                margin-top: 0.5rem;
            }
        }

        /* Custom scrollbar for better visibility */
        .table-container::-webkit-scrollbar {
            height: 8px;
        }

        .table-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .table-container::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        .table-container::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* Table loading state */
        .table-loading {
            position: relative;
            opacity: 0.6;
            pointer-events: none;
        }

        .table-loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 30px;
            height: 30px;
            margin: -15px 0 0 -15px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4158D0;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Table responsive improvements */
        @media (max-width: 1200px) {
        table {
                width: 100%;
        }

        th, td {
                padding: 1rem 0.75rem;
                font-size: 0.85rem;
            }
        }

        @media (max-width: 992px) {
            table {
                width: 100%;
            }
            
            th, td {
                padding: 0.75rem 0.5rem;
                font-size: 0.8rem;
            }



            .btn-download-single, .btn-delete {
                padding: 0.4rem 0.6rem;
                font-size: 0.75rem;
                min-width: 60px;
            }
        }

        /* Table header improvements */
        .table-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem;
            border-radius: 8px 8px 0 0;
            margin-bottom: 0;
            }

        .table-header h3 {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 600;
            }

        /* Enhanced Table Layout with Consistent Alignment */
        table {
                width: 100%;
            border-collapse: collapse;
            border-spacing: 0;
            table-layout: auto;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            }

        /* Natural table column alignments - Desktop */
        .records-table th:nth-child(1),
        .records-table td:nth-child(1) {
            text-align: center;
            padding: 0.75rem 0.25rem;
        }

        .records-table th:nth-child(2),
        .records-table td:nth-child(2) {
            text-align: center;
        }

        .records-table th:nth-child(3),
        .records-table td:nth-child(3) {
            text-align: left;
        }

        .records-table th:nth-child(4),
        .records-table td:nth-child(4) {
            text-align: left;
        }

        .records-table th:nth-child(5),
        .records-table td:nth-child(5) {
            text-align: left;
        }

        .records-table th:nth-child(6),
        .records-table td:nth-child(6) {
            text-align: center;
        }

        .records-table th:nth-child(7),
        .records-table td:nth-child(7) {
            text-align: center;
        }

        .records-table th:nth-child(8),
        .records-table td:nth-child(8) {
            text-align: center;
            padding: 0.75rem 0.25rem;
        }

        .checkbox-header {
            text-align: center;
            padding: 0.75rem 0.5rem;
        }

        .checkbox-header input[type="checkbox"] {
            margin: 0;
        }

        /* Ensure all cells have consistent padding and alignment */
        .records-table th,
        .records-table td {
            padding: 0.75rem 0.5rem;
            vertical-align: middle;
            word-wrap: break-word;
            overflow: hidden;
            text-overflow: ellipsis;
            box-sizing: border-box;
        }

        /* Fixed table layout for perfect alignment */
        .records-table {
            table-layout: auto;
            width: 100%;
        }

        /* Ensure checkbox column is always properly aligned */
        .records-table th:nth-child(1),
        .records-table td:nth-child(1) {
            text-align: center;
            vertical-align: middle;
        }

        /* Ensure action buttons are always visible */
        .records-table th:nth-child(8),
        .records-table td:nth-child(8) {
            text-align: center;
            vertical-align: middle;
        }

        /* Ensure proper column alignment for all columns */
        .records-table th:nth-child(2),
        .records-table td:nth-child(2) {
            text-align: center;
            vertical-align: middle;
        }

        .records-table th:nth-child(3),
        .records-table td:nth-child(3),
        .records-table th:nth-child(4),
        .records-table td:nth-child(4),
        .records-table th:nth-child(5),
        .records-table td:nth-child(5) {
            text-align: left;
            vertical-align: middle;
        }

        .records-table th:nth-child(6),
        .records-table td:nth-child(6),
        .records-table th:nth-child(7),
        .records-table td:nth-child(7) {
            text-align: center;
            vertical-align: middle;
        }

        /* Center the download button in actions column */
        .records-table .btn-download-single {
            margin: 0 auto;
            display: inline-block;
        }

        /* Table Header Styling */
        thead {
            background: linear-gradient(135deg, #4158D0 0%, #C850C0 46%, #FFCC70 100%);
        }

        th {
            padding: 0.75rem 0.5rem;
            border: none;
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
            transition: background-color 0.3s ease;
            box-sizing: border-box;
            }

        /* Ensure headers are always visible and properly sized */
        .records-table th {
            font-size: 0.85rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Specific header styling for better visibility */
        .records-table th:nth-child(1) {
            font-size: 0.8rem;
            padding: 0.75rem 0.25rem;
        }

        .records-table th:nth-child(8) {
            font-size: 0.8rem;
            padding: 0.75rem 0.25rem;
            }

        th:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        th.sortable {
            position: relative;
            padding-right: 2rem;
            }

        th.sortable::after {
            content: '↕';
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.8rem;
            opacity: 0.7;
            }

        th.sort-asc::after {
            content: '↑';
            opacity: 1;
            }

        th.sort-desc::after {
            content: '↓';
            opacity: 1;
        }

        /* Table Body Styling */
        tbody tr {
            transition: all 0.3s ease;
            border-bottom: 1px solid #f0f0f0;
            }

        tbody tr:hover {
            background-color: #f8f9fa;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }

        tbody tr:last-child {
            border-bottom: none;
        }

        td {
            padding: 0.75rem 0.5rem;
            border: none;
            vertical-align: middle;
            line-height: 1.5;
            color: #2c3e50;
                font-size: 0.9rem;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
            }



        /* Standardized Button Styling */
        .btn-download-single, .btn-delete {
            padding: 0.5rem 0.75rem;
            font-size: 0.8rem;
            font-weight: 500;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0.25rem;
            min-width: 80px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
            }

        .btn-download-single {
            background: linear-gradient(135deg, #17a2b8 0%, #6f42c1 100%);
            color: white;
            }

        .btn-download-single:hover {
            background: linear-gradient(135deg, #138496 0%, #5a32a3 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(23, 162, 184, 0.3);
            }

        .btn-delete {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            }

        .btn-delete:hover {
            background: linear-gradient(135deg, #c82333 0%, #a71e2a 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
            }

        /* Checkbox styling */
        .record-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #4158D0;
            }

        /* Empty state styling */
        tbody tr td[colspan] {
            text-align: center;
            padding: 3rem 1rem;
            color: #6c757d;
            font-style: italic;
            background: #f8f9fa;
            }

        /* Improve text visibility and contrast */
        td {
            color: #2c3e50;
            font-weight: 400;
            }

        /* Hover effect for better row visibility */
        tbody tr:hover {
            background-color: #f8f9fa;
        }

        tbody tr:hover td {
            background-color: #f8f9fa;
        }

        @media (max-width: 768px) {
            .records-section {
                padding: 1rem;
            }

            .records-header {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }

            .search-filters {
                flex-direction: column;
                gap: 0.75rem;
            }

            .search-box {
                width: 100%;
            }

            .search-field {
                width: 100%;
            }

            .table-container {
                margin: 0 -0.5rem;
                border-radius: 12px;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                position: relative;
            }

            /* Add visual indicator for horizontal scroll */
            .table-container::after {
                content: '← Scroll →';
                position: absolute;
                bottom: -25px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(59, 130, 246, 0.9);
                color: white;
                padding: 0.25rem 0.75rem;
                border-radius: 12px;
                font-size: 0.75rem;
                font-weight: 600;
                z-index: 5;
            }

            .records-table {
                width: 100%;
                font-size: 0.8rem;
                table-layout: fixed;
            }

            .records-table th,
            .records-table td {
                padding: 0.75rem 0.5rem;
                font-size: 0.8rem;
                white-space: normal;
            }

            /* Natural column alignments for mobile */
            .records-table th:nth-child(1), .records-table td:nth-child(1) { 
                text-align: center;
                padding: 0.75rem 0.25rem;
            }
            .records-table th:nth-child(2), .records-table td:nth-child(2) { 
                text-align: center;
                padding: 0.75rem 0.5rem;
            }
            .records-table th:nth-child(3), .records-table td:nth-child(3) { 
                text-align: left;
                padding: 0.75rem 0.5rem;
            }
            .records-table th:nth-child(4), .records-table td:nth-child(4) { 
                text-align: left;
                padding: 0.75rem 0.5rem;
            }
            .records-table th:nth-child(5), .records-table td:nth-child(5) { 
                text-align: left;
                padding: 0.75rem 0.5rem;
            }
            .records-table th:nth-child(6), .records-table td:nth-child(6) { 
                text-align: center;
                padding: 0.75rem 0.5rem;
            }
            .records-table th:nth-child(7), .records-table td:nth-child(7) { 
                text-align: center;
                padding: 0.75rem 0.5rem;
            }
            .records-table th:nth-child(8), .records-table td:nth-child(8) { 
                text-align: center;
                padding: 0.75rem 0.25rem;
            }

            .btn-download-single, .btn-delete {
                padding: 0.5rem 0.75rem;
                font-size: 0.7rem;
                min-width: 60px;
                margin: 0.1rem;
            }
        }

        @media (max-width: 480px) {
            .table-container {
                margin: 0 -0.75rem;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            /* Add scroll indicator for very small screens */
            .table-container::before {
                content: '← Swipe to see more →';
                position: absolute;
                top: -30px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(65, 88, 208, 0.9);
                color: white;
                padding: 0.25rem 0.75rem;
                border-radius: 12px;
                font-size: 0.7rem;
                font-weight: 600;
                z-index: 5;
                pointer-events: none;
            }

            .records-table {
                width: 100%;
                font-size: 0.75rem;
                table-layout: fixed;
            }

            .records-table th,
            .records-table td {
                padding: 0.5rem 0.4rem;
                font-size: 0.75rem;
            }

            .btn-download-single, .btn-delete {
                padding: 0.4rem 0.6rem;
                font-size: 0.65rem;
                min-width: 50px;
                margin: 0.05rem;
            }

            /* Natural column alignments for small screens */
            .records-table th:nth-child(1), .records-table td:nth-child(1) { 
                text-align: center;
                padding: 0.5rem 0.2rem;
            }
            .records-table th:nth-child(2), .records-table td:nth-child(2) { 
                text-align: center;
                padding: 0.5rem 0.3rem;
            }
            .records-table th:nth-child(3), .records-table td:nth-child(3) { 
                text-align: left;
                padding: 0.5rem 0.3rem;
            }
            .records-table th:nth-child(4), .records-table td:nth-child(4) { 
                text-align: left;
                padding: 0.5rem 0.3rem;
            }
            .records-table th:nth-child(5), .records-table td:nth-child(5) { 
                text-align: left;
                padding: 0.5rem 0.3rem;
            }
            .records-table th:nth-child(6), .records-table td:nth-child(6) { 
                text-align: center;
                padding: 0.5rem 0.3rem;
            }
            .records-table th:nth-child(7), .records-table td:nth-child(7) { 
                text-align: center;
                padding: 0.5rem 0.3rem;
            }
            .records-table th:nth-child(8), .records-table td:nth-child(8) { 
                text-align: center;
                padding: 0.5rem 0.2rem;
            }
        }

        /* Extra small screens */
        @media (max-width: 360px) {
            .records-table {
                width: 100%;
                font-size: 0.7rem;
                table-layout: auto;
            }

            .records-table th,
            .records-table td {
                padding: 0.4rem 0.3rem;
                font-size: 0.7rem;
            }

            .btn-download-single, .btn-delete {
                padding: 0.3rem 0.5rem;
                font-size: 0.6rem;
                min-width: 45px;
                margin: 0.05rem;
            }

            /* Natural column alignments for very small screens */
            .records-table th:nth-child(1), .records-table td:nth-child(1) { 
                text-align: center;
                padding: 0.4rem 0.15rem;
            }
            .records-table th:nth-child(2), .records-table td:nth-child(2) { 
                text-align: center;
                padding: 0.4rem 0.25rem;
            }
            .records-table th:nth-child(3), .records-table td:nth-child(3) { 
                text-align: left;
                padding: 0.4rem 0.25rem;
            }
            .records-table th:nth-child(4), .records-table td:nth-child(4) { 
                text-align: left;
                padding: 0.4rem 0.25rem;
            }
            .records-table th:nth-child(5), .records-table td:nth-child(5) { 
                text-align: left;
                padding: 0.4rem 0.25rem;
            }
            .records-table th:nth-child(6), .records-table td:nth-child(6) { 
                text-align: center;
                padding: 0.4rem 0.25rem;
            }
            .records-table th:nth-child(7), .records-table td:nth-child(7) { 
                text-align: center;
                padding: 0.4rem 0.25rem;
            }
            .records-table th:nth-child(8), .records-table td:nth-child(8) { 
                text-align: center;
                padding: 0.4rem 0.15rem;
            }
        }

        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background-color: #2c3e50;
            color: #fff;
        }

        .nav-links {
            display: flex;
            list-style: none;
            gap: 20px;
        }

        .nav-links li a {
            color: #fff;
            text-decoration: none;
            padding: 8px 12px;
            border-radius: 4px;
            transition: all 0.3s ease;
            font-family: 'Poppins', sans-serif;
            font-size: 0.9rem;
        }

        .nav-links li a:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .nav-links li a.active {
            background-color: #3498db;
            color: #fff;
            font-weight: 600;
        }

        .menu-toggle {
            display: none;
            flex-direction: column;
            justify-content: space-around;
            width: 30px;
            height: 25px;
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 0;
            z-index: 1000;
        }

        .menu-toggle span {
            width: 100%;
            height: 3px;
            background: white;
            border-radius: 2px;
            transition: all 0.3s ease;
            transform-origin: center;
        }

        .menu-toggle.active span:nth-child(1) {
            transform: rotate(45deg) translate(6px, 6px);
        }

        .menu-toggle.active span:nth-child(2) {
            opacity: 0;
        }

        .menu-toggle.active span:nth-child(3) {
            transform: rotate(-45deg) translate(6px, -6px);
        }

        @media (max-width: 768px) {
            .menu-toggle {
                display: flex;
            }

            .nav-links {
                position: fixed;
                top: 0;
                right: -100%;
                width: 280px;
                height: 100vh;
                background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
                flex-direction: column;
                justify-content: flex-start;
                align-items: center;
                padding: 80px 20px 20px;
                transition: right 0.3s ease;
                box-shadow: -5px 0 15px rgba(0, 0, 0, 0.2);
                z-index: 999;
            }

            .nav-links.active {
                right: 0;
            }

            .nav-links li {
                width: 100%;
                margin: 10px 0;
            }

            .nav-links a {
                display: block;
                width: 100%;
                padding: 15px 20px;
                border-radius: 10px;
                font-size: 0.9rem;
                font-weight: 500;
                text-align: center;
                transition: all 0.3s ease;
                border: 1px solid transparent;
            }

            .nav-links a:hover {
                background: rgba(255, 255, 255, 0.1);
                border-color: rgba(255, 255, 255, 0.2);
                transform: translateX(5px);
            }

            .nav-links a.active {
                background: #3498db;
                border-color: #3498db;
                box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
            }

            .nav-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                opacity: 0;
                visibility: hidden;
                transition: all 0.3s ease;
                z-index: 998;
            }

            .nav-overlay.active {
                opacity: 1;
                visibility: visible;
            }
        }

        .btn-delete {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.2s;
        }

        .btn-delete:hover {
            background-color: #c82333;
        }

        @media (max-width: 768px) {
            .patient-ids {
                flex-direction: column;
                gap: 5px;
            }

            .info-grid {
                grid-template-columns: 1fr;
            }

            .profile-section {
                padding: 15px;
            }
        }

        .btn-download {
            background: #3498db;
            color: white;
            padding: 0.6rem 1.2rem;
            border-radius: 8px;
            text-decoration: none;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.2);
            z-index: 1;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .btn-download:hover {
            background: #2980b9;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }

        .btn-download i {
            font-size: 1rem;
        }

        @media (max-width: 768px) {
            .records-list {
                padding: 0 0.75rem;
        }

            .table-container {
                margin-top: 1rem;
            }

            .search-container {
                flex-direction: column;
                align-items: stretch;
                gap: 0.75rem;
            }

            .search-input-group {
                min-width: auto;
            }

            .btn-download {
                padding: 0.5rem 1rem;
                font-size: 0.85rem;
                align-self: flex-end;
                width: auto;
            }
        }

        @media (max-width: 576px) {
            .records-list {
                padding: 0 0.5rem;
            }

            .table-container {
                margin-top: 0.75rem;
            }

            .search-container {
                padding: 1rem;
                gap: 0.5rem;
        }

        .btn-download {
                padding: 0.4rem 0.8rem;
                font-size: 0.8rem;
            }
        }

        @media (max-width: 480px) {
            .records-list {
                padding: 0 0.25rem;
            }

            .table-container {
                margin-top: 0.5rem;
            }

            .search-container {
                padding: 0.75rem;
        }

            .btn-download {
                padding: 0.35rem 0.7rem;
                font-size: 0.75rem;
            }
        }

        .btn-download-single {
            background: linear-gradient(135deg, #17a2b8 0%, #6f42c1 100%);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            margin-right: 8px;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            box-shadow: 0 2px 4px rgba(23, 162, 184, 0.2);
            white-space: nowrap;
            text-decoration: none;
        }

        .btn-download-single:hover {
            background: linear-gradient(135deg, #138496 0%, #5a32a3 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(23, 162, 184, 0.3);
        }

        .btn-download-single:active {
            transform: translateY(0);
        }

        .record-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        /* Modern Profile Card Styles */
        .patient-profile {
            background: #fff;
            border-radius: 20px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
            margin: 2rem auto;
            max-width: 1200px;
            overflow: hidden;
        }

        .profile-header {
            background: linear-gradient(135deg, #4158D0 0%, #C850C0 46%, #FFCC70 100%);
            color: white;
            padding: 3rem;
            position: relative;
            border-bottom: 4px solid rgba(255,255,255,0.2);
        }

        .profile-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(65, 88, 208, 0.3) 0%, rgba(200, 80, 192, 0.3) 46%, rgba(255, 204, 112, 0.3) 100%);
            z-index: 1;
        }

        .profile-header::after {
            content: '';
            position: absolute;
            bottom: -50px;
            right: -50px;
            width: 300px;
            height: 300px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
            z-index: 1;
        }

        .patient-basic-info {
            position: relative;
            z-index: 2;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .patient-basic-info h2 {
            font-size: 2.6rem;
            margin: 0 0 1.5rem 0;
            font-weight: 700;
            color: #ffffff;
            letter-spacing: 0.5px;
        }

        .patient-ids {
            display: flex;
            gap: 2rem;
            font-size: 1.1rem;
            background: rgba(255, 255, 255, 0.15);
            padding: 1.2rem 2rem;
            border-radius: 12px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .patient-ids span {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .patient-ids strong {
            color: #FFCC70;
            font-weight: 600;
        }

        .profile-content {
            padding: 2.5rem;
            display: grid;
            gap: 2.5rem;
            background: #ffffff;
        }

        .profile-section {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            transition: all 0.3s ease;
            border: 1px solid rgba(0,0,0,0.05);
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        .profile-section:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f0f0f0;
        }

        .section-header i {
            font-size: 1.5rem;
            color: #4158D0;
            background: linear-gradient(135deg, #4158D0 0%, #C850C0 46%, #FFCC70 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .section-header h3 {
            margin: 0;
            color: #2c3e50;
            font-size: 1.4rem;
            font-weight: 600;
            background: linear-gradient(135deg, #4158D0 0%, #C850C0 46%, #FFCC70 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .info-item {
            background: #ffffff;
            padding: 1.2rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            border: 1px solid rgba(65, 88, 208, 0.1);
        }

        .info-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(65, 88, 208, 0.15);
            border-color: rgba(65, 88, 208, 0.3);
            background: #ffffff;
        }

        .info-item label {
            font-size: 0.8rem;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.75rem;
            display: block;
            font-weight: 600;
        }

        .info-item span {
            color: #2c3e50;
            font-size: 1rem;
            line-height: 1.5;
            display: block;
        }

        .info-item.full-width {
            grid-column: 1 / -1;
            background: white;
        }

        /* Pregnancy Section Specific Styles */
        #pregnancyProfileSection {
            background: #ffffff !important;
            border: 1px solid rgba(65, 88, 208, 0.1);
        }

        #pregnancyProfileSection .info-item {
            background: white;
            border: 1px solid rgba(65, 88, 208, 0.1);
        }

        #pregnancyProfileSection .section-header {
            border-bottom-color: rgba(65, 88, 208, 0.2);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .profile-header {
                padding: 1rem;
            }

            .patient-basic-info h2 {
                font-size: 1.8rem;
            }

            .patient-ids {
                flex-direction: column;
                gap: 0.5rem;
                padding: 0.5rem;
            }

            .profile-content {
                padding: 0.5rem;
                gap: 1rem;
            }

            .info-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .profile-section {
                padding: 1rem;
                margin: 0;
            }

            .tab-pane {
                padding: 1rem;
            }

            .tab-section {
                margin-bottom: 1rem;
            }

            .info-item {
                padding: 1rem;
                margin: 0;
            }

            .search-container {
                padding: 1rem;
                margin-bottom: 1rem;
            }

            .records-list {
                padding: 0;
                margin-top: 1rem;
            }

            .table-container {
                margin-top: 1rem;
            }
        }

        /* Animation for Profile Sections */
        .profile-section {
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Custom Scrollbar */
        .profile-content::-webkit-scrollbar {
            width: 8px;
        }

        .profile-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .profile-content::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #4158D0 0%, #C850C0 46%, #FFCC70 100%);
            border-radius: 4px;
        }

        .profile-content::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #4158D0 0%, #C850C0 46%, #FFCC70 100%);
        }

        .btn-edit {
            background: #3498db;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            margin-top: 1rem;
        }

        .btn-edit:hover {
            background: #2980b9;
            transform: translateY(-1px);
        }

        .input-field {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 0.95rem;
            transition: border-color 0.2s ease;
        }

        .input-field:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        /* Pregnancy Section Specific Styles */
        #pregnancyProfileSection {
            background: #ffffff !important;
        }

        #pregnancyProfileSection .info-item {
            background: white;
            border: 1px solid rgba(52, 152, 219, 0.1);
        }

        #pregnancyProfileSection .section-header {
            border-bottom-color: rgba(52, 152, 219, 0.2);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .profile-header {
                padding: 1rem;
            }

            .patient-basic-info h2 {
                font-size: 1.6rem;
            }

            .patient-ids {
                flex-direction: column;
                gap: 0.5rem;
                padding: 0.5rem;
            }

            .profile-content {
                padding: 0.5rem;
                gap: 1rem;
            }

            .info-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .profile-section {
                padding: 1rem;
                margin: 0;
            }
        }

        /* Animation for Profile Sections */
        .profile-section {
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Form Layout Styles */
        .form-section {
            background: #fff;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-group label {
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
            outline: none;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid #f0f2f5;
        }

        .section-header i {
            font-size: 1.25rem;
            color: #3498db;
        }

        .section-header h3 {
            margin: 0;
            color: #2c3e50;
            font-size: 1.25rem;
        }

        /* Responsive Design */
        @media screen and (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .form-section {
                padding: 1.5rem;
            }

            .form-group input,
            .form-group select,
            .form-group textarea {
                padding: 0.6rem;
            }
        }

        @media screen and (max-width: 480px) {
            .form-section {
                padding: 1rem;
            }

            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            .form-group label {
                font-size: 0.85rem;
            }
        }

        /* Modern Form Styles */
        .modern-form {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .modern-form .form-group {
            margin-bottom: 1.5rem;
        }

        .modern-form label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #2c3e50;
            font-weight: 600;
            margin-bottom: 0.75rem;
        }

        .modern-form label i {
            color: #3498db;
        }

        .modern-form .form-control {
            width: 100%;
            padding: 0.875rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background-color: #f8fafc;
        }

        .modern-form .form-control:focus {
            border-color: #3498db;
            background-color: white;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
            outline: none;
        }

        .modern-form textarea.form-control {
            min-height: 80px;
            max-height: 150px;
            resize: vertical;
        }

        .modern-form .form-actions {
            margin-top: 2rem;
            text-align: right;
        }

        .modern-form .btn-primary {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(52, 152, 219, 0.2);
        }

        .modern-form .btn-primary:hover {
            background-color: #2980b9;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(52, 152, 219, 0.3);
        }

        .modern-form .btn-primary:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(52, 152, 219, 0.2);
        }

        .modern-form .form-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 2rem;
            margin-bottom: 1rem;
        }

        .modern-form .form-group {
            margin-bottom: 0;
            min-width: 0; /* Prevents overflow */
        }

        .modern-form label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #2c3e50;
            font-weight: 600;
            margin-bottom: 0.5rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .modern-form .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            background-color: #f8fafc;
        }

        .modern-form textarea.form-control.compact {
            min-height: 40px;
            max-height: 60px;
            resize: vertical;
            overflow-y: auto;
            padding: 0.5rem;
        }

        @media (max-width: 1200px) {
            .modern-form .form-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .modern-form {
                padding: 1.5rem;
            }

            .modern-form .form-grid {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }

            .modern-form .btn-primary {
                width: 100%;
                justify-content: center;
            }
        }

        /* Enhanced Responsive Design */
        @media (max-width: 1200px) {
            .patient-profile {
                max-width: 95%;
                margin: 1.5rem auto;
            }
            
            .profile-content {
                padding: 2rem;
                gap: 2rem;
            }
            
            .info-grid {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 1.25rem;
            }
        }

        @media (max-width: 992px) {
            .patient-profile {
                max-width: 98%;
                margin: 1rem auto;
            }
            
            .profile-header {
                padding: 2.5rem;
            }
            
            .patient-basic-info h2 {
                font-size: 2.2rem;
            }
            
            .patient-ids {
                flex-direction: column;
                gap: 1rem;
                padding: 1rem 1.5rem;
            }
            
            .profile-content {
                padding: 1.5rem;
                gap: 1.5rem;
            }
            
            .profile-section {
                padding: 1.5rem;
            }
            
            .info-grid {
                grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
                gap: 1rem;
            }
        }

        @media (max-width: 768px) {
            .patient-profile {
                max-width: 100%;
                margin: 0.5rem;
                border-radius: 12px;
            }
            
            .profile-header {
                padding: 2rem;
            }
            
            .profile-header::after {
                width: 200px;
                height: 200px;
                bottom: -30px;
                right: -30px;
            }
            
            .patient-basic-info h2 {
                font-size: 1.8rem;
                margin-bottom: 1rem;
            }
            
            .patient-ids {
                padding: 0.75rem 1rem;
                font-size: 0.9rem;
            }
            
            .profile-content {
                padding: 1rem;
                gap: 1rem;
            }
            
            .profile-section {
                padding: 1rem;
                border-radius: 12px;
            }
            
            .section-header {
                margin-bottom: 1.5rem;
                padding-bottom: 0.75rem;
            }
            
            .section-header h3 {
                font-size: 1.2rem;
            }
            
            .info-grid {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }
            
            .info-item {
                padding: 1rem;
            }
            
            .info-item label {
                font-size: 0.75rem;
                margin-bottom: 0.5rem;
            }
            
            .info-item span {
                font-size: 0.9rem;
            }
            
            /* Enhanced table responsiveness */
            .table-container {
                margin: 0 -0.5rem;
                border-radius: 8px;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            table {
                min-width: 600px;
                font-size: 0.85rem;
                border-collapse: collapse;
                width: 100%;
                background: white;
                border-radius: 12px;
                overflow: hidden;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            }
            
            th, td {
                padding: 0.75rem 0.5rem;
                white-space: nowrap;
                border-bottom: 1px solid #e2e8f0;
                text-align: left;
            }
            
            th {
                background: linear-gradient(135deg, #4158D0 0%, #C850C0 46%, #FFCC70 100%);
                color: white;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }
            
            tbody tr:hover {
                background-color: #f8fafc;
            }
            
            /* Responsive table for small screens */
            @media (max-width: 768px) {
                .table-container {
                    margin: 0;
                    border-radius: 0;
                    overflow: visible;
                }
                
                /* Show table on mobile with responsive design */
                table {
                    display: table;
                }
                

                
                .record-card {
                    background: white;
                    border-radius: 16px;
                    padding: 1.25rem;
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                    border: 1px solid #e2e8f0;
                    transition: all 0.3s ease;
                    position: relative;
                    overflow: hidden;
                }
                
                .record-card::before {
                    content: '';
                    position: absolute;
                    top: 0;
                    left: 0;
                    right: 0;
                    height: 4px;
                    background: linear-gradient(135deg, #4158D0 0%, #C850C0 46%, #FFCC70 100%);
            }
            
                .record-card:hover {
                    transform: translateY(-4px);
                    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            }
            
                .record-card-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: flex-start;
                    margin-bottom: 1rem;
                    padding-bottom: 0.75rem;
                    border-bottom: 1px solid #f1f5f9;
            }
            
                .record-date {
                    font-weight: 700;
                    color: #2c3e50;
                    font-size: 1.1rem;
                    display: flex;
                    align-items: center;
                    gap: 0.5rem;
                }
                
                .record-date::before {
                    content: '📅';
                    font-size: 1rem;
                }
                
                .record-actions {
                    display: flex;
                gap: 0.5rem;
                    flex-wrap: wrap;
            }
            
                .record-card-content {
                    display: grid;
                    gap: 1rem;
            }
            
                .record-field {
                    display: flex;
                    flex-direction: column;
                    gap: 0.5rem;
                padding: 0.75rem;
                border-radius: 8px;
                    background: #f8fafc;
                    border-left: 4px solid transparent;
            }
            
                .record-field-label {
                    font-size: 0.75rem;
                    font-weight: 700;
                    color: #64748b;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                    display: flex;
                    align-items: center;
                gap: 0.5rem;
            }
            
                .record-field-value {
                    font-size: 0.9rem;
                    color: #1e293b;
                    line-height: 1.4;
                    word-wrap: break-word;
                    font-weight: 500;
            }
            
                .record-field-value:empty::before {
                    content: "Not specified";
                    color: #94a3b8;
                    font-style: italic;
                    font-weight: normal;
            }
            
                /* Color-coded fields with icons */
                .record-field.diagnosis {
                    border-left-color: #dc2626;
                    background: linear-gradient(135deg, rgba(220, 38, 38, 0.05) 0%, rgba(220, 38, 38, 0.02) 100%);
            }
            
                .record-field.diagnosis .record-field-label::before {
                    content: '🔴';
                }
                
                .record-field.diagnosis .record-field-value {
                    color: #dc2626;
            }
            
                .record-field.treatment {
                    border-left-color: #059669;
                    background: linear-gradient(135deg, rgba(5, 150, 105, 0.05) 0%, rgba(5, 150, 105, 0.02) 100%);
            }
            
                .record-field.treatment .record-field-label::before {
                    content: '🟢';
                }
                
                .record-field.treatment .record-field-value {
                    color: #059669;
            }
            
                .record-field.medication {
                    border-left-color: #7c3aed;
                    background: linear-gradient(135deg, rgba(124, 58, 237, 0.05) 0%, rgba(124, 58, 237, 0.02) 100%);
            }
                
                .record-field.medication .record-field-label::before {
                    content: '🟣';
                }
                
                .record-field.medication .record-field-value {
                    color: #7c3aed;
            }
            
                .record-field.doctor {
                    border-left-color: #2563eb;
                    background: linear-gradient(135deg, rgba(37, 99, 235, 0.05) 0%, rgba(37, 99, 235, 0.02) 100%);
            }
            
                .record-field.doctor .record-field-label::before {
                    content: '👨‍⚕️';
                }
                
                .record-field.doctor .record-field-value {
                    color: #2563eb;
            }
            
                .record-field.hospital {
                    border-left-color: #ea580c;
                    background: linear-gradient(135deg, rgba(234, 88, 12, 0.05) 0%, rgba(234, 88, 12, 0.02) 100%);
            }
            
                .record-field.hospital .record-field-label::before {
                    content: '🏥';
                }
                
                .record-field.hospital .record-field-value {
                    color: #ea580c;
            }
            
                /* Action buttons */
                .record-actions .btn-download-single,
                .record-actions .btn-delete {
                    padding: 0.6rem 1rem;
                    font-size: 0.8rem;
                    border-radius: 8px;
                    border: none;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    display: inline-flex;
                    align-items: center;
                    gap: 0.4rem;
                    font-weight: 600;
                    min-width: 80px;
                    justify-content: center;
            }
            
                .record-actions .btn-download-single {
                    background: linear-gradient(135deg, #3b82f6, #1d4ed8);
                    color: white;
            }
            
                .record-actions .btn-download-single:hover {
                    background: linear-gradient(135deg, #2563eb, #1e40af);
                    transform: translateY(-2px);
                    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
            }
            
                .record-actions .btn-delete {
                    background: linear-gradient(135deg, #ef4444, #dc2626);
                    color: white;
            }
            
                .record-actions .btn-delete:hover {
                    background: linear-gradient(135deg, #dc2626, #b91c1c);
                    transform: translateY(-2px);
                    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
            }
            
                /* Ensure table is always visible on mobile */
            .table-container {
                    display: block !important;
                }
            }
        }

        /* Extra small screens - further optimize table */
        @media (max-width: 480px) {
            .records-table-mobile {
                padding: 0.15rem;
                margin: 0 -0.5rem;
            }
            
            .mobile-table {
                min-width: 600px;
                font-size: 0.75rem;
                border-radius: 6px;
            }
            
            .mobile-table th {
                padding: 0.6rem 0.4rem;
                font-size: 0.7rem;
                letter-spacing: 0.2px;
            }
            
            .mobile-table td {
                padding: 0.6rem 0.4rem;
                font-size: 0.75rem;
                max-width: 100px;
            }
            
            .mobile-table .btn-download-single,
            .mobile-table .btn-delete {
                padding: 0.3rem 0.5rem;
                font-size: 0.65rem;
                min-width: 50px;
                gap: 0.15rem;
            }
            
            .mobile-table td:first-child {
                min-width: 70px;
            }
            
            .mobile-table td:last-child {
                min-width: 90px;
            }
        }

        @media (max-width: 360px) {
            .patient-basic-info h2 {
                font-size: 1.1rem;
            }
            
            .patient-ids {
                font-size: 0.7rem;
                padding: 0.25rem 0.5rem;
            }
            
            .profile-content {
                padding: 0.25rem;
            }
            
            .profile-section {
                padding: 0.25rem;
            }
            
            .info-item {
                padding: 0.25rem;
            }
            
            .info-item label {
                font-size: 0.6rem;
            }
            
            .info-item span {
                font-size: 0.75rem;
            }
            
            /* Ultra small screen table optimization */
            .records-table-mobile {
                padding: 0.1rem;
                margin: 0 -0.75rem;
            }
            
            .mobile-table {
                min-width: 550px;
                font-size: 0.7rem;
            }
            
            .mobile-table th {
                padding: 0.5rem 0.3rem;
                font-size: 0.65rem;
            }
            
            .mobile-table td {
                padding: 0.5rem 0.3rem;
                font-size: 0.7rem;
                max-width: 80px;
            }
            
            .mobile-table .btn-download-single,
            .mobile-table .btn-delete {
                padding: 0.25rem 0.4rem;
                font-size: 0.6rem;
                min-width: 45px;
            }
            
            .mobile-table td:first-child {
                min-width: 60px;
            }
            
            .mobile-table td:last-child {
                min-width: 80px;
            }
        }

        /* Landscape orientation adjustments */
        @media (max-height: 500px) and (orientation: landscape) {
            .profile-header {
                padding: 1rem;
            }
            
            .patient-basic-info h2 {
                font-size: 1.5rem;
                margin-bottom: 0.5rem;
            }
            
            .patient-ids {
                padding: 0.5rem 1rem;
                font-size: 0.8rem;
            }
            
            .profile-content {
                padding: 0.5rem;
                gap: 0.5rem;
            }
            
            .profile-section {
                padding: 0.5rem;
            }
        }

        /* High DPI displays */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .info-item {
                border-width: 0.5px;
            }
            
            .section-header {
                border-bottom-width: 1px;
            }
        }

        /* Print styles */
        @media print {
            .patient-profile {
                box-shadow: none;
                border: 1px solid #ccc;
            }
            
            .profile-header {
                background: #f8f9fa !important;
                color: #333 !important;
            }
            
            .btn-edit, .btn-primary, .btn-delete {
                display: none;
            }
            
            .table-container {
                box-shadow: none;
                border: 1px solid #ccc;
            }
        }

        /* Mobile-friendly improvements */
        @media (max-width: 768px) {
            /* Touch-friendly buttons */
            .btn-edit, .btn-primary, .btn-delete, .btn-download {
                min-height: 44px;
                min-width: 44px;
                touch-action: manipulation;
            }
            
            /* Better form inputs for mobile */
            .input-field {
                font-size: 16px; /* Prevents zoom on iOS */
                padding: 12px;
                border-radius: 8px;
                border: 2px solid #e1e5e9;
                transition: border-color 0.3s ease;
            }
            
            .input-field:focus {
                border-color: #4158D0;
                outline: none;
                box-shadow: 0 0 0 3px rgba(65, 88, 208, 0.1);
            }
            
            /* Improved table scrolling */
            .table-container {
                -webkit-overflow-scrolling: touch;
                scrollbar-width: thin;
                scrollbar-color: #4158D0 #f1f1f1;
            }
            
            .table-container::-webkit-scrollbar {
                height: 6px;
            }
            
            .table-container::-webkit-scrollbar-track {
                background: #f1f1f1;
                border-radius: 3px;
            }
            
            .table-container::-webkit-scrollbar-thumb {
                background: #4158D0;
                border-radius: 3px;
            }
            
            .table-container::-webkit-scrollbar-thumb:hover {
                background: #2c3e50;
            }
            
            /* Better spacing for touch targets */
            .info-item {
                margin-bottom: 8px;
            }
            
            /* Improved section headers */
            .section-header {
                position: sticky;
                top: 0;
                background: white;
                z-index: 10;
                margin: -1rem -1rem 1rem -1rem;
                padding: 1rem;
                border-radius: 12px 12px 0 0;
            }

            /* Enhanced table action buttons for mobile */
            .records-table {
                width: 100%;
            }

            .records-table th:nth-child(2),
            .records-table td:nth-child(2) {
                width: auto;
                min-width: 60px;
            }

            .records-table th:nth-child(3),
            .records-table td:nth-child(3),
            .records-table th:nth-child(4),
            .records-table td:nth-child(4),
            .records-table th:nth-child(5),
            .records-table td:nth-child(5) {
                width: auto;
                min-width: 80px;
            }

            .records-table th:nth-child(6),
            .records-table td:nth-child(6),
            .records-table th:nth-child(7),
            .records-table td:nth-child(7) {
                width: auto;
                min-width: 70px;
            }

            .records-table th:nth-child(8),
            .records-table td:nth-child(8) {
                width: auto;
                min-width: 100px;
                white-space: nowrap;
            }

            .records-table .btn-download-single,
            .records-table .btn-delete {
                padding: 0.5rem 0.75rem;
                font-size: 0.8rem;
                min-width: 50px;
                margin: 0.1rem;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                gap: 0.25rem;
            }

            .records-table .btn-download-single i,
            .records-table .btn-delete i {
                font-size: 0.75rem;
            }

            /* Responsive actions header */
            .records-table .actions-header {
                width: 120px;
                min-width: 120px;
                max-width: 120px;
                padding: 0.75rem 0.5rem;
                font-size: 0.85rem;
            }

            .records-table .actions-header i {
                font-size: 0.8rem;
            }
        }

        @media (max-width: 576px) {
            /* Further optimize action buttons for small screens */
            .records-table {
                width: 100%;
            }

            .records-table th:nth-child(2),
            .records-table td:nth-child(2) {
                width: auto;
                min-width: 50px;
            }

            .records-table th:nth-child(3),
            .records-table td:nth-child(3),
            .records-table th:nth-child(4),
            .records-table td:nth-child(4),
            .records-table th:nth-child(5),
            .records-table td:nth-child(5) {
                width: auto;
                min-width: 70px;
            }

            .records-table th:nth-child(6),
            .records-table td:nth-child(6),
            .records-table th:nth-child(7),
            .records-table td:nth-child(7) {
                width: auto;
                min-width: 60px;
            }

            .records-table th:nth-child(8),
            .records-table td:nth-child(8) {
                width: auto;
                min-width: 90px;
                padding: 0.5rem 0.25rem;
            }

            .records-table .btn-download-single,
            .records-table .btn-delete {
                padding: 0.4rem 0.6rem;
                font-size: 0.75rem;
                min-width: 45px;
                margin: 0.05rem;
            }

            .records-table .btn-download-single i,
            .records-table .btn-delete i {
                font-size: 0.7rem;
            }

            /* Hide delete button on mobile - show only download */
            .records-table .btn-delete {
                display: none !important;
            }

            /* Center the download button in actions column */
            .records-table td:nth-child(8) {
                text-align: center;
                vertical-align: middle;
            }

            .records-table .btn-download-single {
                margin: 0 auto;
                display: inline-block;
            }

            /* Small screen actions header */
            .records-table .actions-header {
                width: 110px;
                min-width: 110px;
                max-width: 110px;
                padding: 0.6rem 0.25rem;
                font-size: 0.8rem;
                text-align: center;
            }

            .records-table .actions-header i {
                font-size: 0.75rem;
            }
        }

        @media (max-width: 480px) {
            /* Ultra-compact action buttons */
            .records-table {
                width: 100%;
            }

            .records-table th:nth-child(2),
            .records-table td:nth-child(2) {
                width: auto;
                min-width: 45px;
            }

            .records-table th:nth-child(3),
            .records-table td:nth-child(3),
            .records-table th:nth-child(4),
            .records-table td:nth-child(4),
            .records-table th:nth-child(5),
            .records-table td:nth-child(5) {
                width: auto;
                min-width: 60px;
            }

            .records-table th:nth-child(6),
            .records-table td:nth-child(6),
            .records-table th:nth-child(7),
            .records-table td:nth-child(7) {
                width: auto;
                min-width: 50px;
            }

            .records-table th:nth-child(8),
            .records-table td:nth-child(8) {
                width: auto;
                min-width: 80px;
                padding: 0.4rem 0.2rem;
            }

            .records-table .btn-download-single,
            .records-table .btn-delete {
                padding: 0.35rem 0.5rem;
                font-size: 0.7rem;
                min-width: 40px;
                margin: 0.02rem;
            }

            .records-table .btn-download-single i,
            .records-table .btn-delete i {
                font-size: 0.65rem;
            }

            /* Hide delete button on mobile - show only download */
            .records-table .btn-delete {
                display: none !important;
            }

            /* Center the download button in actions column */
            .records-table td:nth-child(8) {
                text-align: center;
                vertical-align: middle;
            }

            .records-table .btn-download-single {
                margin: 0 auto;
                display: inline-block;
            }

            /* Compact actions header */
            .records-table .actions-header {
                width: 100px;
                min-width: 100px;
                max-width: 100px;
                padding: 0.5rem 0.2rem;
                font-size: 0.75rem;
                text-align: center;
            }

            .records-table .actions-header i {
                font-size: 0.7rem;
            }
        }

        /* Accessibility improvements */
        @media (prefers-reduced-motion: reduce) {
            .profile-section,
            .info-item,
            .btn-edit,
            .btn-primary,
            .btn-delete {
                transition: none;
            }
            
            .profile-section:hover,
            .info-item:hover {
                transform: none;
            }
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            .info-item {
                border: 2px solid #000;
            }
            
            .section-header {
                border-bottom: 3px solid #000;
            }
            
            .btn-edit, .btn-primary {
                border: 2px solid #000;
            }
        }

        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            .patient-profile {
                background: #1a1a1a;
                color: #ffffff;
            }
            
            .profile-section {
                background: #2d2d2d;
                border-color: #404040;
            }
            
            .info-item {
                background: #333333;
                border-color: #404040;
            }
            
            .info-item label {
                color: #cccccc;
            }
            
            .info-item span {
                color: #ffffff;
            }
            
            .section-header {
                border-bottom-color: #404040;
            }
            
            .table-container {
                background: #2d2d2d;
            }
            
            th {
                background-color: #333333;
                color: #ffffff;
            }
            
            td {
                color: #ffffff;
                border-bottom-color: #404040;
            }
        }

        /* Focus styles for better accessibility */
        .btn-edit:focus,
        .btn-primary:focus,
        .btn-delete:focus,
        .input-field:focus {
            outline: 2px solid #4158D0;
            outline-offset: 2px;
        }

        /* Loading states */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #4158D0;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .btn-secondary:hover {
            background: #6c757d;
            transform: translateY(-2px);
        }

        /* Referral Feedback Section Styles */
        .referral-feedback-section {
            background: #fff;
            border-radius: 20px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
            margin: 2rem auto;
            max-width: 1400px;
            overflow: hidden;
            width: 100%;
            box-sizing: border-box;
        }

        .feedback-container {
            padding: 2rem;
        }

        .feedback-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #e9ecef;
        }

        .feedback-header .section-header {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .feedback-header h2 {
            margin: 0;
            color: #2c3e50;
            font-size: 1.5rem;
        }

        .btn-collapse {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #6c757d;
        }

        .btn-collapse:hover {
            background: #e9ecef;
            color: #495057;
        }

        .feedback-content {
            transition: all 0.3s ease;
        }

        .feedback-info {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .feedback-info p {
            margin: 0;
            color: #1976d2;
            font-size: 0.95rem;
        }

        .feedback-info i {
            margin-right: 0.5rem;
        }

        .feedback-form {
            background: #ffffff;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .feedback-form .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .feedback-form .form-group.full-width {
            grid-column: 1 / -1;
        }

        .feedback-form .form-group label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .feedback-form .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ced4da;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
        }

        .feedback-form .form-control:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .feedback-form .form-control[readonly] {
            background: #f8f9fa;
            color: #6c757d;
        }

        .feedback-form .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        .feedback-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 1rem;
        }

        .success-content {
            text-align: center;
        }

        .success-content i {
            font-size: 3rem;
            color: #28a745;
            margin-bottom: 1rem;
        }

        .success-content h3 {
            color: #155724;
            margin-bottom: 0.5rem;
        }

        .success-content p {
            color: #155724;
            margin-bottom: 1rem;
        }

        .success-details {
            display: flex;
            justify-content: center;
            gap: 2rem;
            font-size: 0.9rem;
            color: #155724;
        }

        .feedback-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 1rem;
        }

        .error-content {
            text-align: center;
        }

        .error-content i {
            font-size: 3rem;
            color: #dc3545;
            margin-bottom: 1rem;
        }

        .error-content h3 {
            color: #721c24;
            margin-bottom: 0.5rem;
        }

        .error-content p {
            color: #721c24;
        }

        /* Responsive design for feedback section */
        @media (max-width: 768px) {
            .feedback-form .form-grid {
                grid-template-columns: 1fr;
            }
            
            .feedback-form .form-actions {
                flex-direction: column;
            }
            
            .success-details {
                flex-direction: column;
                gap: 0.5rem;
            }
        }
        
        /* Global override to ensure table is always visible on small screens */
        @media (max-width: 768px) {
            .table-container {
                display: block !important;
            }
            table {
                display: table !important;
            }
            
            /* Table header styling */
            .table-header {
                background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
                padding: 1.5rem;
                border-bottom: 2px solid #e2e8f0;
                border-radius: 16px 16px 0 0;
                text-align: center;
            }
            
            .table-header h3 {
                margin: 0 0 0.5rem 0;
                color: #1e293b;
                font-size: 1.5rem;
                font-weight: 700;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 0.5rem;
            }
            
            .table-header p {
                margin: 0;
                color: #64748b;
                font-size: 0.95rem;
                font-weight: 500;
            }
            
                    /* Table container styles */
        .table-container {
            overflow-x: auto;
            margin: 0 -1rem;
            padding: 0;
            border-radius: 16px;
            background: white;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid #e2e8f0;
        }

        /* Records table styles - Fixed alignment */
        .records-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            table-layout: auto;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            min-width: 1000px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .records-table th,
        .records-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
            vertical-align: middle;
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: normal;
            box-sizing: border-box;
        }

        .records-table th {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 50%, #60a5fa 100%);
            color: white;
            font-weight: 700;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: nowrap;
        }

        .records-table tr:hover {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        }

        .records-table tr:last-child td {
            border-bottom: none;
        }

        /* Fixed column widths - CRITICAL for alignment */
        .records-table th:nth-child(1), 
        .records-table td:nth-child(1) { 
            width: 60px !important; 
            min-width: 60px !important; 
            max-width: 60px !important; 
            text-align: center !important; 
            padding: 1rem 0.5rem !important;
        }

        .records-table th:nth-child(2), 
        .records-table td:nth-child(2) { 
            width: 120px !important; 
            min-width: 120px !important; 
            max-width: 120px !important; 
            padding: 1rem 0.75rem !important;
        }

        .records-table th:nth-child(3), 
        .records-table td:nth-child(3) { 
            width: 180px !important; 
            min-width: 180px !important; 
            max-width: 180px !important; 
            padding: 1rem 0.75rem !important;
        }

        .records-table th:nth-child(4), 
        .records-table td:nth-child(4) { 
            width: 180px !important; 
            min-width: 180px !important; 
            max-width: 180px !important; 
            padding: 1rem 0.75rem !important;
        }

        .records-table th:nth-child(5), 
        .records-table td:nth-child(5) { 
            width: 180px !important; 
            min-width: 180px !important; 
            max-width: 180px !important; 
            padding: 1rem 0.75rem !important;
        }

        .records-table th:nth-child(6), 
        .records-table td:nth-child(6) { 
            width: 140px !important; 
            min-width: 140px !important; 
            max-width: 140px !important; 
            padding: 1rem 0.75rem !important;
        }

        .records-table th:nth-child(7), 
        .records-table td:nth-child(7) { 
            width: 140px !important; 
            min-width: 140px !important; 
            max-width: 140px !important; 
            padding: 1rem 0.75rem !important;
        }

        .records-table th:nth-child(8), 
        .records-table td:nth-child(8) { 
            width: 140px !important; 
            min-width: 140px !important; 
            max-width: 140px !important; 
            text-align: center !important; 
            padding: 1rem 0.5rem !important;
        }

        /* Table container for proper scrolling */
        .table-container {
            overflow-x: auto;
            width: 100%;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            background: white;
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        }

        /* Custom scrollbar styling */
        .table-container::-webkit-scrollbar {
            height: 8px;
        }

        .table-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .table-container::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        .table-container::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
            
            /* Remove conflicting table styles - using .records-table specific styles instead */
            
            /* Remove conflicting styles - using .records-table specific styles instead */
            
                    /* Enhanced action buttons with better organization */
        .btn-download-single, .btn-delete {
            padding: 0.7rem 1rem;
            font-size: 0.75rem;
            min-width: 70px;
            margin: 0.2rem;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.4rem;
            font-weight: 700;
            box-shadow: 0 3px 6px rgba(0,0,0,0.15);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }

        /* Ensure table headers and content stay aligned */
        .records-table thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .records-table tbody {
            position: relative;
        }

        /* Add subtle borders to help with alignment */
        .records-table th:not(:last-child),
        .records-table td:not(:last-child) {
            border-right: 1px solid #e2e8f0;
        }
            
            .btn-download-single {
                background: linear-gradient(135deg, #059669 0%, #10b981 50%, #34d399 100%);
                color: white;
                border: 2px solid #059669;
            }
            
            .btn-download-single:hover {
                background: linear-gradient(135deg, #047857 0%, #059669 50%, #10b981 100%);
                transform: translateY(-2px);
                box-shadow: 0 6px 12px rgba(5, 150, 105, 0.4);
                border-color: #047857;
            }
            
            .btn-delete {
                background: linear-gradient(135deg, #dc2626 0%, #ef4444 50%, #f87171 100%);
                color: white;
                border: 2px solid #dc2626;
            }
            
            .btn-delete:hover {
                background: linear-gradient(135deg, #b91c1c 0%, #dc2626 50%, #ef4444 100%);
                transform: translateY(-2px);
                box-shadow: 0 6px 12px rgba(220, 38, 38, 0.4);
                border-color: #b91c1c;
            }
            
            /* Button icons styling */
            .btn-download-single i, .btn-delete i {
                font-size: 0.8rem;
                transition: transform 0.3s ease;
            }
            
            .btn-download-single:hover i {
                transform: translateY(-1px);
            }
            
            .btn-delete:hover i {
                transform: translateY(-1px);
            }
            

            
            /* Mobile table header improvements */
            .table-container thead th {
                position: sticky;
                top: 0;
                background: linear-gradient(135deg, #4158D0 0%, #C850C0 46%, #FFCC70 100%);
                color: white;
                font-weight: 600;
                z-index: 10;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            
            /* Mobile table body improvements */
            .table-container tbody tr {
                border-bottom: 1px solid #e2e8f0;
                transition: background-color 0.2s ease;
            }
            
            .table-container tbody tr:hover {
                background-color: #f1f5f9;
                transform: scale(1.01);
            }
            
            /* Enhanced checkbox styling */
            .table-container input[type="checkbox"] {
                width: 20px;
                height: 20px;
                accent-color: #3b82f6;
                cursor: pointer;
                border-radius: 4px;
                border: 2px solid #e2e8f0;
                transition: all 0.3s ease;
                position: relative;
            }
            
            .table-container input[type="checkbox"]:checked {
                background-color: #3b82f6;
                border-color: #3b82f6;
                box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
            }
            
            .table-container input[type="checkbox"]:hover {
                border-color: #3b82f6;
                transform: scale(1.1);
            }
            
            /* Select all checkbox styling */
            .table-container th input[type="checkbox"] {
                width: 22px;
                height: 22px;
                accent-color: #1e40af;
            }
            
            /* Enhanced empty state styling */
            .table-container tbody tr td[colspan] {
                text-align: center;
                padding: 3rem 2rem;
                color: #64748b;
                font-style: italic;
                background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
                border-radius: 12px;
                margin: 1rem 0;
                border: 2px dashed #cbd5e1;
                font-size: 1.1rem;
                font-weight: 500;
                position: relative;
            }
            
            .table-container tbody tr td[colspan]::before {
                content: '📋';
                font-size: 2rem;
                display: block;
                margin-bottom: 1rem;
                opacity: 0.7;
            }
            
            /* Table header organization improvements */
            .table-container thead th {
                position: sticky;
                top: 0;
                background: linear-gradient(135deg, #1e40af 0%, #3b82f6 50%, #60a5fa 100%);
                color: white;
                font-weight: 700;
                z-index: 10;
                box-shadow: 0 4px 12px rgba(30, 64, 175, 0.3);
                border-bottom: 3px solid #1e40af;
                text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            }
            
            /* Table body organization improvements */
            .table-container tbody tr {
                border-bottom: 1px solid #e2e8f0;
                transition: all 0.3s ease;
                position: relative;
            }
            
            .table-container tbody tr:hover {
                background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
                border-left-color: #3b82f6;
                transform: translateX(3px);
                box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
                z-index: 1;
            }
            
            /* Row numbering for better organization */
            .table-container tbody tr::before {
                content: counter(row-counter);
                counter-increment: row-counter;
                position: absolute;
                left: -30px;
                top: 50%;
                transform: translateY(-50%);
                background: #3b82f6;
                color: white;
                width: 24px;
                height: 24px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 0.7rem;
                font-weight: 700;
                opacity: 0;
                transition: opacity 0.3s ease;
            }
            
            .table-container tbody tr:hover::before {
                opacity: 1;
            }
            
            /* Counter initialization */
            .table-container tbody {
                counter-reset: row-counter;
            }
            
            /* Table footer styling */
            .table-footer {
                background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
                border-top: 2px solid #e2e8f0;
                padding: 1rem;
            }
            
            .footer-content {
                display: flex;
                justify-content: space-between;
                align-items: center;
                font-size: 0.9rem;
                color: #64748b;
                font-weight: 500;
            }
            
            .record-count, .last-updated {
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }
            
            .record-count i, .last-updated i {
                color: #3b82f6;
                font-size: 0.8rem;
            }
            
            .record-count span {
                font-weight: 700;
                color: #1e293b;
            }
            
            .last-updated span {
                font-weight: 600;
                color: #059669;
            }
        }

        /* --- Enhanced Mobile Table Usability --- */
        @media (max-width: 768px) {
            .table-container {
                box-shadow: 0 2px 12px rgba(30, 64, 175, 0.08);
                border-radius: 12px;
                background: #fff;
                margin: 0 -0.5rem 1.5rem -0.5rem;
                overflow-x: auto;
                position: relative;
            }
            .table-container::after {
                content: '';
                position: absolute;
                top: 0; right: 0; bottom: 0;
                width: 16px;
                pointer-events: none;
                background: linear-gradient(to left, #fff 60%, transparent 100%);
                z-index: 2;
                display: block;
            }
            .records-table {
                min-width: 700px;
                font-size: 0.85rem;
                border-radius: 12px;
                background: #fff;
            }
            .records-table th, .records-table td {
                padding: 0.65rem 0.5rem;
                font-size: 0.85rem;
                white-space: nowrap;
                text-align: left;
                vertical-align: middle;
            }
            .records-table th {
                font-size: 0.8rem;
            }
            .records-table th:nth-child(1), .records-table td:nth-child(1) { min-width: 80px; max-width: 90px; }
            .records-table th:nth-child(2), .records-table td:nth-child(2) { min-width: 120px; max-width: 140px; }
            .records-table th:nth-child(3), .records-table td:nth-child(3) { min-width: 120px; max-width: 140px; }
            .records-table th:nth-child(4), .records-table td:nth-child(4) { min-width: 120px; max-width: 140px; }
            .records-table th:nth-child(5), .records-table td:nth-child(5) { min-width: 120px; max-width: 140px; }
            .records-table th:nth-child(6), .records-table td:nth-child(6) { min-width: 120px; max-width: 140px; }
            .records-table th:nth-child(7), .records-table td:nth-child(7) { min-width: 120px; max-width: 140px; }
            .records-table th:last-child, .records-table td:last-child { min-width: 110px; max-width: 120px; text-align: center; }
            .records-table td {
                border-bottom: 1px solid #e2e8f0;
            }
            .records-table tr:last-child td {
                border-bottom: none;
            }
            /* Touch-friendly action buttons */
            .btn-download-single, .btn-delete {
                min-width: 48px;
                min-height: 44px;
                font-size: 0.95rem;
                padding: 0.5rem 0.7rem;
                margin: 0 0.15rem;
                border-radius: 8px;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                gap: 0.4rem;
                box-shadow: 0 1px 4px rgba(30, 64, 175, 0.08);
            }
            .btn-download-single {
                background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%);
                color: #fff;
                border: none;
            }
            .btn-delete {
                background: linear-gradient(135deg, #ef4444 0%, #f87171 100%);
                color: #fff;
                border: none;
            }
            .btn-download-single:active, .btn-delete:active {
                transform: scale(0.97);
            }
            /* Checkbox column: keep small */
            .records-table th:first-child, .records-table td:first-child {
                min-width: 40px;
                max-width: 50px;
                text-align: center;
            }
            /* Subtle border for table */
            .records-table {
                border: 1px solid #e2e8f0;
            }
        }
        /* Extra small screens */
        @media (max-width: 480px) {
            .records-table {
                min-width: 600px;
                font-size: 0.8rem;
            }
            .records-table th, .records-table td {
                padding: 0.5rem 0.3rem;
                font-size: 0.8rem;
            }
            .btn-download-single, .btn-delete {
                min-width: 44px;
                min-height: 40px;
                font-size: 0.85rem;
                padding: 0.4rem 0.5rem;
            }
        }
        .records-header-pro {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1.2rem;
            background: linear-gradient(90deg, #4158D0 0%, #C850C0 46%, #FFCC70 100%);
            box-shadow: 0 4px 24px rgba(65, 88, 208, 0.10);
            border-radius: 18px;
            padding: 2rem 1.5rem 1.5rem 1.5rem;
            margin: 2.5rem auto 2rem auto;
            max-width: 700px;
            width: 100%;
            position: relative;
        }
        .records-header-pro i {
            font-size: 2.5rem;
            color: #fff;
            filter: drop-shadow(0 2px 8px rgba(65, 88, 208, 0.15));
        }
        .records-header-pro h1 {
            margin: 0;
            font-size: 2.2rem;
            font-weight: 800;
            color: #fff;
            letter-spacing: 1px;
            text-shadow: 0 2px 8px rgba(65, 88, 208, 0.10);
        }
        @media (max-width: 768px) {
            .records-header-pro {
                flex-direction: column;
                gap: 0.7rem;
                padding: 1.2rem 0.5rem 1rem 0.5rem;
                margin: 1.2rem auto 1rem auto;
            }
            .records-header-pro h1 {
                font-size: 1.3rem;
            }
            .records-header-pro i {
                font-size: 1.7rem;
            }
        }
    </style>

    <script>
        // Initialize jsPDF
        window.jsPDF = window.jspdf.jsPDF;

        const patientPIN = "1234";
        const medicalRecordsSection = document.getElementById("medicalRecords");
        const pinError = document.getElementById("pinError");
        const addPatientSection = document.getElementById("addPatientSection");
        const records = [];

        // Show/hide pregnancy section based on gender
        document.getElementById("gender").addEventListener("change", (e) => {
            const pregnancySection = document.getElementById("pregnancySection");
            if (e.target.value === "female") {
                pregnancySection.style.display = "block";
            } else {
                pregnancySection.style.display = "none";
                document.getElementById("pregnancy_status").value = "";
                document.getElementById("due_date").value = "";
                document.getElementById("gestational_age").value = "";
                document.getElementById("pregnancy_complications").value = "";
                document.getElementById("pregnancyDetails").style.display = "none";
            }
        });

        // Show/hide pregnancy details based on pregnancy status
        document.getElementById("pregnancy_status").addEventListener("change", (e) => {
            const pregnancyDetails = document.getElementById("pregnancyDetails");
            if (e.target.value === "pregnant") {
                pregnancyDetails.style.display = "block";
            } else {
                pregnancyDetails.style.display = "none";
                document.getElementById("due_date").value = "";
                document.getElementById("gestational_age").value = "";
                document.getElementById("pregnancy_complications").value = "";
            }
        });

        // Add this event listener for the PIN form
        document.getElementById('pinForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            await fetchProfile();
        });

        // Add this function to handle profile fetching
        async function fetchProfile() {
            const pin = document.getElementById('patientPin').value;
            if (!pin) {
                alert('Please enter your PIN');
                return;
            }

            // Validate PIN format
            if (!/^\d{6}$/.test(pin)) {
                const pinError = document.getElementById('pinError');
                pinError.textContent = 'PIN must be exactly 6 digits';
                pinError.style.display = 'block';
                return;
            }

            try {
                // First check if the backend is available
                const healthResponse = await apiCall('/health');
                if (!healthResponse.ok) {
                    throw new Error('Backend service is not available');
                }

                // Then fetch the profile
                const response = await apiCall(`/api/patient/profile?pin=${encodeURIComponent(pin)}`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                let responseData;
                try {
                    responseData = await response.json();
                } catch (e) {
                    console.error('Error parsing response:', e);
                    throw new Error('Invalid response from server');
                }

                if (!response.ok) {
                    throw new Error(responseData.error || 'Failed to fetch profile');
                }

                // Store the PIN for future use
                window.currentPatientPIN = pin;
                
                // Show the medical records section and hide the auth section
                document.getElementById('medicalRecords').style.display = 'block';
                document.querySelector('.auth-section').style.display = 'none';
                
                // Update the profile display
                console.log('Initial patient data loaded:', responseData);
                console.log('Initial pregnancy data:', {
                    pregnancy_status: responseData.pregnancy_status,
                    lmp_date: responseData.lmp_date,
                    due_date: responseData.due_date,
                    gestational_age: responseData.gestational_age,
                    pregnancy_complications: responseData.pregnancy_complications
                });
                console.log('Initial medical data:', {
                    allergies: responseData.allergies,
                    medications: responseData.medications
                });
                updateProfileDisplay(responseData);
                
                // Fetch and display medical records
                try {
                    const recordsResponse = await apiCall(`/api/patient/medical-records?pin=${encodeURIComponent(pin)}`);
                    if (recordsResponse.ok) {
                        const records = await recordsResponse.json();
                        displayRecords(records);
                    }
                } catch (error) {
                    console.warn('Could not fetch medical records:', error);
                }
            } catch (error) {
                console.error('Error:', error);
                const pinError = document.getElementById('pinError');
                pinError.textContent = error.message || 'Failed to fetch profile. Please try again.';
                pinError.style.display = 'block';
            }
        }

        // Add this function to calculate gestational age
        function calculateGestationalAge(lmpDate) {
                if (!lmpDate) return null;
                
            try {
                const lmp = new Date(lmpDate);
                const today = new Date();
                const diffTime = Math.abs(today - lmp);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                const weeks = Math.floor(diffDays / 7);
                const days = diffDays % 7;
                
                return `${weeks} weeks, ${days} days`;
            } catch (error) {
                console.error('Error calculating gestational age:', error);
                return null;
            }
        }

        // Update the profile display function
        function updateProfileDisplay(profile) {
            try {
                console.log('Updating profile display with data:', profile);
                
                // Helper function to safely update element text
                function updateElement(id, value, defaultValue = 'Not available') {
                    const element = document.getElementById(id);
                    if (element) {
                        let displayValue;
                        
                        // Handle different types of values
                        if (value === null || value === undefined || value === '') {
                            displayValue = defaultValue;
                        } else if (Array.isArray(value)) {
                            // Handle array values (like allergies and medications)
                            displayValue = value.length > 0 ? value.join(', ') : defaultValue;
                        } else {
                            displayValue = value.toString();
                        }
                        
                        element.textContent = displayValue;
                        
                        // Ensure text is visible
                        element.style.color = '#1a202c';
                        element.style.display = 'block';
                        
                        // Add visual feedback for updated elements
                        element.style.backgroundColor = '#ffffff';
                        element.style.border = '1px solid #1a202c';
                        element.style.padding = '2px 4px';
                        element.style.borderRadius = '3px';
                        element.style.color = '#000000';
                        
                        // Remove the highlight after 3 seconds
                        setTimeout(() => {
                            element.style.backgroundColor = '';
                            element.style.border = '';
                            element.style.padding = '';
                            element.style.borderRadius = '';
                            // Keep the text color and visibility
                            element.style.color = '#1a202c';
                            element.style.display = 'block';
                        }, 3000);
                        
                        console.log(`Updated element ${id} with value: ${displayValue}`);
                        console.log(`Element ${id} computed styles:`, {
                            color: window.getComputedStyle(element).color,
                            display: window.getComputedStyle(element).display,
                            visibility: window.getComputedStyle(element).visibility,
                            opacity: window.getComputedStyle(element).opacity
                        });
                    } else {
                        console.warn(`Element with id ${id} not found`);
                    }
                }

                // Basic Information
                updateElement('patientNameDisplay', profile.name);
                updateElement('patientDobDisplay', profile.date_of_birth ? new Date(profile.date_of_birth).toLocaleDateString() : null);
                updateElement('patientGenderDisplay', profile.gender);
                updateElement('patientBloodTypeDisplay', profile.blood_type);
                updateElement('patientMaritalStatusDisplay', profile.marital_status);
                updateElement('patientLanguageDisplay', profile.language);
                updateElement('patientNationalityDisplay', profile.nationality);
                
                // Contact Information
                updateElement('patientEmailDisplay', profile.email);
                updateElement('patientPhoneDisplay', profile.phone);
                
                // Format address without duplication
                let addressParts = [];
                if (profile.address_line && profile.address_line.trim()) {
                    addressParts.push(profile.address_line.trim());
                }
                if (profile.city && profile.city.trim() && !profile.address_line.includes(profile.city)) {
                    addressParts.push(profile.city.trim());
                }
                if (profile.state && profile.state.trim() && !profile.address_line.includes(profile.state)) {
                    addressParts.push(profile.state.trim());
                }
                if (profile.postal_code && profile.postal_code.trim() && !profile.address_line.includes(profile.postal_code)) {
                    addressParts.push(profile.postal_code.trim());
                }
                if (profile.country && profile.country.trim() && !profile.address_line.includes(profile.country)) {
                    addressParts.push(profile.country.trim());
                }
                updateElement('patientAddressDisplay', addressParts.length > 0 ? addressParts.join(', ') : null);
                
                // Medical Information
                updateElement('patientAllergiesDisplay', profile.allergies, 'None reported');
                updateElement('patientMedicationsDisplay', profile.medications, 'None reported');
                
                // Emergency Contact
                updateElement('emergencyContactNameDisplay', profile.emergency_contact_name);
                updateElement('emergencyContactPhoneDisplay', profile.emergency_contact_phone);
                updateElement('emergencyContactRelationshipDisplay', profile.emergency_contact_relationship);
                
                // Patient IDs
                updateElement('patientIdDisplay', profile.id);
                updateElement('patientFhirIdDisplay', profile.fhir_id);

                // Update Overview Stats
                updateElement('bloodTypeDisplay', profile.blood_type || 'N/A');
                updateElement('pregnancyStatus', profile.pregnancy_status || 'N/A');

                // Pregnancy Information
                const pregnancyInfo = document.getElementById('pregnancyInfo');
                const pregnancyProfileSection = document.getElementById('pregnancyProfileSection');
                
                if (profile.gender === 'female') {
                    if (pregnancyInfo) pregnancyInfo.style.display = 'block';
                    if (pregnancyProfileSection) pregnancyProfileSection.style.display = 'block';
                    
                    // Update basic pregnancy fields
                    updateElement('patientPregnancyStatusDisplay', profile.pregnancy_status);
                    
                    // Calculate due date and gestational age from LMP if available
                    if (profile.lmp_date) {
                        const lmp = new Date(profile.lmp_date);
                        const today = new Date();
                        
                        // Calculate gestational age
                        const diffTime = Math.abs(today - lmp);
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        const weeks = Math.floor(diffDays / 7);
                        const days = diffDays % 7;
                        const gestationalAgeText = `${weeks} weeks, ${days} days`;
                        
                        // Calculate estimated due date (LMP + 280 days = 40 weeks)
                        const dueDate = new Date(lmp);
                        dueDate.setDate(dueDate.getDate() + 280);
                        
                        updateElement('patientDueDateDisplay', dueDate.toLocaleDateString());
                        updateElement('patientGestationalAgeDisplay', gestationalAgeText);
                    } else {
                        updateElement('patientDueDateDisplay', profile.due_date ? new Date(profile.due_date).toLocaleDateString() : 'Not available');
                        updateElement('patientGestationalAgeDisplay', profile.gestational_age ? `${profile.gestational_age} weeks` : 'Not available');
                    }
                    
                    updateElement('patientPregnancyComplicationsDisplay', profile.pregnancy_complications, 'None reported');
                    
                    // Update detailed pregnancy fields
                    console.log('Updating pregnancy fields:', {
                        pregnancy_status: profile.pregnancy_status,
                        previous_pregnancies: profile.previous_pregnancies,
                        lmp_date: profile.lmp_date,
                        due_date: profile.due_date,
                        gestational_age: profile.gestational_age,
                        multiple_pregnancy: profile.multiple_pregnancy,
                        risk_level: profile.risk_level,
                        risk_factors: profile.risk_factors,
                        blood_pressure: profile.blood_pressure,
                        hemoglobin: profile.hemoglobin,
                        blood_sugar: profile.blood_sugar,
                        weight: profile.weight,
                        prenatal_vitamins: profile.prenatal_vitamins,
                        pregnancy_complications: profile.pregnancy_complications,
                        emergency_hospital: profile.emergency_hospital,
                        birth_plan: profile.birth_plan
                    });
                    
                    console.log('Medical info fields:', {
                        allergies: profile.allergies,
                        medications: profile.medications
                    });
                    
                    updateElement('pregnancyStatusDisplay', profile.pregnancy_status);
                    updateElement('previousPregnanciesDisplay', profile.previous_pregnancies);
                    
                    // Handle LMP date and gestational age
                    if (profile.lmp_date) {
                        updateElement('lmpDateDisplay', new Date(profile.lmp_date).toLocaleDateString());
                        
                        // Calculate gestational age from LMP
                        const lmp = new Date(profile.lmp_date);
                        const today = new Date();
                        const diffTime = Math.abs(today - lmp);
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        const weeks = Math.floor(diffDays / 7);
                        const days = diffDays % 7;
                        const gestationalAgeText = `${weeks} weeks, ${days} days`;
                        updateElement('gestationalAgeDisplay', gestationalAgeText);
                        
                        // Calculate and update due date from LMP
                        const dueDate = new Date(lmp);
                        dueDate.setDate(dueDate.getDate() + 280);
                        updateElement('dueDateDisplay', dueDate.toLocaleDateString());
                    } else {
                        updateElement('lmpDateDisplay', 'Not available');
                        updateElement('gestationalAgeDisplay', 'Not available');
                        updateElement('dueDateDisplay', profile.due_date ? new Date(profile.due_date).toLocaleDateString() : 'Not available');
                    }
                    
                    updateElement('multiplePregnancyDisplay', profile.multiple_pregnancy);
                    updateElement('riskLevelDisplay', profile.risk_level);
                    
                    // Handle risk factors
                    if (profile.risk_factors) {
                        try {
                            const riskFactors = typeof profile.risk_factors === 'string' ? 
                                JSON.parse(profile.risk_factors) : profile.risk_factors;
                            updateElement('riskFactorsDisplay', Array.isArray(riskFactors) ? 
                                riskFactors.join(', ') : 'None');
                        } catch (e) {
                            updateElement('riskFactorsDisplay', profile.risk_factors);
                        }
                    } else {
                        updateElement('riskFactorsDisplay', 'None');
                    }

                    // Update medical measurements
                    updateElement('bloodPressureDisplay', profile.blood_pressure);
                    updateElement('hemoglobinDisplay', profile.hemoglobin ? `${profile.hemoglobin} g/dL` : null);
                    updateElement('bloodSugarDisplay', profile.blood_sugar ? `${profile.blood_sugar} mg/dL` : null);
                    updateElement('weightDisplay', profile.weight ? `${profile.weight} kg` : null);
                    
                    // Update other pregnancy details
                    updateElement('prenatalVitaminsDisplay', profile.prenatal_vitamins);
                    updateElement('pregnancyComplicationsDisplay', profile.pregnancy_complications, 'None reported');
                    updateElement('emergencyHospitalDisplay', profile.emergency_hospital);
                    updateElement('birthPlanDisplay', profile.birth_plan);
                } else {
                    if (pregnancyInfo) pregnancyInfo.style.display = 'none';
                    if (pregnancyProfileSection) pregnancyProfileSection.style.display = 'none';
                }

                // Update the display name in the header
                updateElement('patientNameHeader', profile.name, 'Patient Profile');
                
                // Scroll to pregnancy section if it exists and has data
                if (profile.gender === 'female' && (profile.pregnancy_status || profile.lmp_date || profile.due_date)) {
                    const pregnancySection = document.getElementById('pregnancyProfileSection');
                    if (pregnancySection) {
                        setTimeout(() => {
                            pregnancySection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }, 500);
                    }
                }
                
            } catch (error) {
                console.error('Error updating profile display:', error);
                alert('Error updating profile display. Please try again.');
            }
        }

        // Form validation and conditional display functions
        function validatePhoneNumber(phone) {
            const phoneRegex = /^\+232\d{8}$/;
            return phoneRegex.test(phone);
        }

        function validateEmail(email) {
            const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
            return emailRegex.test(email);
        }

        function validateBloodPressure(bp) {
            if (!bp) return true; // Optional field
            const bpRegex = /^\d{2,3}\/\d{2,3}$/;
            if (!bpRegex.test(bp)) return false;
            
            const [systolic, diastolic] = bp.split('/').map(Number);
            return systolic >= 70 && systolic <= 200 && 
                   diastolic >= 40 && diastolic <= 130 && 
                   systolic > diastolic;
        }

        function getSelectedValues(selectElement) {
            const selected = [];
            for (let option of selectElement.options) {
                if (option.selected && option.value) {
                    selected.push(option.value);
                }
            }
            return selected;
        }

        // Handle gender change to show/hide pregnancy section
        document.getElementById('gender').addEventListener('change', function() {
            const gender = this.value;
            const pregnancySection = document.getElementById('pregnancySection');
            const pregnancyDetails = document.getElementById('pregnancyDetails');
            
            if (gender === 'female') {
                pregnancySection.style.display = 'block';
            } else {
                pregnancySection.style.display = 'none';
                pregnancyDetails.style.display = 'none';
            }
        });

        // Handle pregnancy status change
        document.getElementById('pregnancy_status').addEventListener('change', function() {
            const status = this.value;
            const pregnancyDetails = document.getElementById('pregnancyDetails');
            
            if (status === 'pregnant') {
                pregnancyDetails.style.display = 'block';
            } else {
                pregnancyDetails.style.display = 'none';
            }
        });

        // Real-time validation
        document.getElementById('phone').addEventListener('blur', function() {
            const phone = this.value;
            if (phone && !validatePhoneNumber(phone)) {
                this.setCustomValidity('Phone number must be in Sierra Leone format: +232XXXXXXXX');
                this.reportValidity();
            } else {
                this.setCustomValidity('');
            }
        });

        document.getElementById('email').addEventListener('blur', function() {
            const email = this.value;
            if (email && !validateEmail(email)) {
                this.setCustomValidity('Please enter a valid email address');
                this.reportValidity();
            } else {
                this.setCustomValidity('');
            }
        });

        document.getElementById('blood_pressure').addEventListener('blur', function() {
            const bp = this.value;
            if (bp && !validateBloodPressure(bp)) {
                this.setCustomValidity('Blood pressure must be in format: systolic/diastolic (e.g., 120/80)');
                this.reportValidity();
            } else {
                this.setCustomValidity('');
            }
        });

        // Add form help styles
        const style = document.createElement('style');
        style.textContent = `
            .form-help {
                display: block;
                margin-top: 0.25rem;
                font-size: 0.875rem;
                color: #6c757d;
            }
            
            .form-control:invalid {
                border-color: #dc3545;
            }
            
            .form-control:valid {
                border-color: #28a745;
            }
        `;
        document.head.appendChild(style);

        document.getElementById("addPatientForm").addEventListener("submit", async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            
            // Construct the full name from first, middle, and last name
            const firstName = data.first_name || '';
            const middleName = data.middle_name || '';
            const lastName = data.last_name || '';
            
            // Create full name by combining the parts
            const fullName = [firstName, middleName, lastName].filter(part => part.trim()).join(' ');
            
            // Add the constructed name fields to the data object
            data.name = fullName;
            data.given_name = firstName;
            data.family_name = lastName;
            
            // Handle multi-select fields
            data.allergies = getSelectedValues(document.getElementById('allergies'));
            data.medications = getSelectedValues(document.getElementById('medications'));
            data.risk_factors = getSelectedValues(document.getElementById('risk_factors'));
            data.pregnancy_complications = getSelectedValues(document.getElementById('pregnancy_complications'));
            
            // Validate required fields
            if (!validatePhoneNumber(data.phone)) {
                alert('Phone number must be in Sierra Leone format: +232XXXXXXXX');
                return;
            }
            
            if (!validateEmail(data.email)) {
                alert('Please enter a valid email address');
                return;
            }
            
            if (data.blood_pressure && !validateBloodPressure(data.blood_pressure)) {
                alert('Blood pressure must be in format: systolic/diastolic (e.g., 120/80)');
                return;
            }
            
            const submitButton = e.target.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.textContent = 'Registering...';
            
            try {
                // Use relative URL to work with both local and Docker setups
                const response = await apiCall('/api/patient/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(`Registration successful! A 6-digit PIN has been sent to ${data.email}\n\nPlease check your email (including spam folder) for your PIN. You will need this PIN to access your medical records.`);
                    e.target.reset();
                    document.getElementById("addPatientSection").style.display = "none";
                    document.querySelector(".auth-section").style.display = "block";
                } else if (response.status === 409) {
                    alert(`${result.error}\n\nIf you've forgotten your PIN, please contact support for assistance.`);
                    document.getElementById("email").value = "";
                } else {
                    throw new Error(result.error || 'Failed to register patient');
                }
            } catch (error) {
                console.error('Error registering patient:', error);
                alert(`Registration failed: ${error.message || 'Unknown error'}\n\nPlease try again or contact support if the problem persists.`);
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Register Patient';
            }
        });

        document.getElementById("addRecordForm").addEventListener("submit", async (e) => {
            e.preventDefault();
            
            if (!window.currentPatientPIN) {
                alert('Please access your profile first before adding records.');
                return;
            }
            
            const recordData = {
                pin: window.currentPatientPIN,
                date: document.getElementById("date").value,
                diagnosis: document.getElementById("diagnosis").value,
                treatment: document.getElementById("treatment").value,
                medication: document.getElementById("medication").value,
                doctor: document.getElementById("doctor").value,
                hospital: document.getElementById("hospital").value
            };
            
            try {
                const response = await apiCall('/api/patient/medical-records', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(recordData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('Medical record added successfully!');
                    e.target.reset();
                    
                    // Fetch updated records using query parameter
                    const recordsResponse = await apiCall(`/api/patient/medical-records?pin=${window.currentPatientPIN}`, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json'
                        }
                    });
                    
                    if (recordsResponse.ok) {
                        const records = await recordsResponse.json();
                        displayRecords(records);
                    } else {
                        throw new Error('Failed to fetch updated records');
                    }
                } else {
                    throw new Error(result.error || 'Failed to add medical record');
                }
            } catch (error) {
                console.error('Error adding record:', error);
                alert(error.message || 'Error adding medical record. Please try again.');
            }
        });

        // Add search functionality
        let allRecords = [
            // Sample data for testing
            {
                id: 1,
                date: '2024-01-15',
                diagnosis: 'Hypertension',
                treatment: 'Lifestyle modification and medication',
                medication: 'Amlodipine 5mg daily',
                doctor: 'Dr. Sarah Johnson',
                hospital: 'City General Hospital'
            },
            {
                id: 2,
                date: '2024-02-20',
                diagnosis: 'Type 2 Diabetes',
                treatment: 'Diet control and exercise',
                medication: 'Metformin 500mg twice daily',
                doctor: 'Dr. Michael Chen',
                hospital: 'Community Health Center'
            },
            {
                id: 3,
                date: '2024-03-10',
                diagnosis: 'Upper Respiratory Infection',
                treatment: 'Rest and fluids',
                medication: 'Acetaminophen as needed',
                doctor: 'Dr. Emily Davis',
                hospital: 'Urgent Care Clinic'
            }
        ]; // Store all records for searching

        function displayRecords(records) {
            allRecords = records; // Store all records
            updateOverviewStats(records); // Update overview stats
            filterAndDisplayRecords();
        }

        function filterAndDisplayRecords() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const searchField = document.getElementById('searchField').value;
            
            console.log('All records:', allRecords);
            console.log('Search term:', searchTerm);
            console.log('Search field:', searchField);
            
            const filteredRecords = allRecords.filter(record => {
                if (!searchTerm) return true; // Show all records if no search term
                
                if (searchField === 'all') {
                    // Search in all fields
                    return Object.values(record).some(value => 
                        String(value).toLowerCase().includes(searchTerm)
                    );
                } else if (searchField === 'date') {
                    // Special handling for date search
                    const recordDate = new Date(record.date).toLocaleDateString().toLowerCase();
                    const searchDate = searchTerm.toLowerCase();
                    return recordDate.includes(searchDate);
                } else {
                    // Search in specific field
                    const fieldValue = String(record[searchField] || '').toLowerCase();
                    return fieldValue.includes(searchTerm);
                }
            });
            
            console.log('Filtered records:', filteredRecords);

            const tableBody = document.getElementById("recordsTableBody");
            tableBody.innerHTML = "";
            
            console.log('Table body found:', tableBody);
            
            if (!filteredRecords || filteredRecords.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">No records found</td></tr>';
                document.getElementById('bulkDownloadBtn').style.display = 'none';
                return;
            }
            
            // Sort records by date in descending order (newest first)
            filteredRecords.sort((a, b) => new Date(b.date) - new Date(a.date));

            filteredRecords.forEach(record => {
                // Create table row
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td data-label="Select"><input type="checkbox" class="record-checkbox" data-record-id="${record.id}" onchange="updateBulkDownloadButton()"></td>
                    <td data-label="Date">${new Date(record.date).toLocaleDateString()}</td>
                    <td data-label="Diagnosis">${record.diagnosis || 'N/A'}</td>
                    <td data-label="Treatment">${record.treatment || 'N/A'}</td>
                    <td data-label="Medication">${record.medication || 'N/A'}</td>
                    <td data-label="Doctor">${record.doctor || 'N/A'}</td>
                    <td data-label="Hospital">${record.hospital || 'N/A'}</td>
                    <td data-label="Actions">
                        <button onclick="downloadSingleRecord(${record.id})" class="btn-download-single">
                            <i class="fas fa-download"></i> Download
                        </button>
                        <button onclick="deleteRecord(${record.id})" class="btn-delete">Delete</button>
                    </td>
                `;
                tableBody.appendChild(row);


            });

            // Update bulk download button visibility
            updateBulkDownloadButton();
            
            // Update table footer information
            updateTableFooter(filteredRecords.length);
            
            // Show/hide table vs cards based on screen size
            updateTableDisplay();
        }

        function updateTableDisplay() {
            // Force table layout recalculation
            const table = document.querySelector('.records-table');
            if (table) {
                table.style.display = 'none';
                setTimeout(() => {
                    table.style.display = 'table';
                    table.style.tableLayout = 'auto';
                    table.style.width = '100%';
                    
                    // Force recalculation for mobile devices
                    const container = document.querySelector('.table-container');
                    if (container) {
                        container.style.overflowX = 'auto';
                        container.style.webkitOverflowScrolling = 'touch';
                    }
                    
                    // Ensure perfect alignment between headers and data cells
                    const headers = table.querySelectorAll('th');
                    const firstRow = table.querySelector('tbody tr');
                    if (firstRow) {
                        const dataCells = firstRow.querySelectorAll('td');
                        headers.forEach((header, index) => {
                            if (dataCells[index]) {
                                // Ensure same padding and box-sizing
                                header.style.padding = dataCells[index].style.padding || '0.75rem 0.5rem';
                                header.style.verticalAlign = 'middle';
                                header.style.boxSizing = 'border-box';
                                
                                // Apply column-specific text alignment
                                if (index === 0) {
                                    // Center align: checkbox column
                                    header.style.textAlign = 'center';
                                    dataCells[index].style.textAlign = 'center';
                                } else if (index === 1) {
                                    // Center align: date column
                                    header.style.textAlign = 'center';
                                    dataCells[index].style.textAlign = 'center';
                                } else if (index === 2 || index === 3 || index === 4) {
                                    // Left align: diagnosis, treatment, medication
                                    header.style.textAlign = 'left';
                                    dataCells[index].style.textAlign = 'left';
                                } else if (index === 5 || index === 6) {
                                    // Center align: doctor, hospital
                                    header.style.textAlign = 'center';
                                    dataCells[index].style.textAlign = 'center';
                                } else if (index === 7) {
                                    // Center align: actions column with button
                                    header.style.textAlign = 'center';
                                    dataCells[index].style.textAlign = 'center';
                                    // Ensure button is centered in the cell
                                    const button = dataCells[index].querySelector('.btn-download-single');
                                    if (button) {
                                        button.style.margin = '0 auto';
                                        button.style.display = 'inline-block';
                                    }
                                }
                            }
                        });
                    }
                    
                    // Ensure all columns are properly sized
                    const cells = table.querySelectorAll('th, td');
                    cells.forEach(cell => {
                        cell.style.boxSizing = 'border-box';
                        cell.style.wordWrap = 'break-word';
                        cell.style.overflowWrap = 'break-word';
                    });
                }, 10);
            }
        }

        // Add event listener for window resize with debouncing
        let resizeTimeout;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(updateTableDisplay, 250);
        });
        
        // Also handle orientation change on mobile
        window.addEventListener('orientationchange', function() {
            setTimeout(updateTableDisplay, 500);
        });
        
        // Initialize table display on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing tables...');
            filterAndDisplayRecords();
            updateTableDisplay();
            
            // Add event listeners for search functionality
            const searchInput = document.getElementById('searchInput');
            const searchField = document.getElementById('searchField');
            
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    console.log('Search input changed:', this.value);
                    updateClearSearchButton();
                    filterAndDisplayRecords();
                });
                
                searchInput.addEventListener('keyup', function(e) {
                    if (e.key === 'Enter') {
                        filterAndDisplayRecords();
                    }
                });
                
                searchInput.addEventListener('focus', function() {
                    updateClearSearchButton();
                });
            }
            
            if (searchField) {
                searchField.addEventListener('change', function() {
                    console.log('Search field changed:', this.value);
                    filterAndDisplayRecords();
                });
            }
        });

        function toggleAllRecords() {
            const selectAll = document.getElementById('selectAllRecords');
            const checkboxes = document.getElementsByClassName('record-checkbox');
            Array.from(checkboxes).forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
            updateBulkDownloadButton();
        }

        function updateBulkDownloadButton() {
            const checkboxes = document.getElementsByClassName('record-checkbox');
            const bulkDownloadBtn = document.getElementById('bulkDownloadBtn');
            const anyChecked = Array.from(checkboxes).some(checkbox => checkbox.checked);
            bulkDownloadBtn.style.display = anyChecked ? 'inline-block' : 'none';
        }
        
        function updateTableFooter(recordCount) {
            const totalRecordsElement = document.getElementById('totalRecordsCount');
            const lastUpdatedElement = document.getElementById('lastUpdatedTime');
            
            if (totalRecordsCount) {
                totalRecordsCount.textContent = recordCount;
            }
            
            if (lastUpdatedElement) {
                const now = new Date();
                lastUpdatedElement.textContent = now.toLocaleString();
            }
        }

        function clearSearch() {
            const searchInput = document.getElementById('searchInput');
            const clearSearchBtn = document.getElementById('clearSearchBtn');
            
            if (searchInput) {
                searchInput.value = '';
                clearSearchBtn.style.display = 'none';
                filterAndDisplayRecords();
            }
        }

        function updateClearSearchButton() {
            const searchInput = document.getElementById('searchInput');
            const clearSearchBtn = document.getElementById('clearSearchBtn');
            
            if (searchInput && clearSearchBtn) {
                if (searchInput.value.trim() !== '') {
                    clearSearchBtn.style.display = 'inline-block';
                } else {
                    clearSearchBtn.style.display = 'none';
                }
            }
        }

        function downloadSingleRecord(recordId) {
            try {
                const record = allRecords.find(r => r.id === recordId);
                if (!record) {
                    alert('Record not found');
                    return;
                }

                const doc = new jsPDF();
                
                // Add title
                doc.setFontSize(16);
                doc.text('Medical Record', 14, 15);
                
                // Add patient info
                doc.setFontSize(12);
                doc.text(`Patient: ${document.getElementById('patientNameDisplay').textContent}`, 14, 25);
                doc.text(`Date: ${new Date(record.date).toLocaleDateString()}`, 14, 35);
                
                // Add record details
                doc.setFontSize(11);
                const details = [
                    ['Field', 'Details'],
                    ['Diagnosis', record.diagnosis || 'N/A'],
                    ['Treatment', record.treatment || 'N/A'],
                    ['Medication', record.medication || 'N/A'],
                    ['Doctor', record.doctor || 'N/A'],
                    ['Hospital', record.hospital || 'N/A']
                ];
                
                doc.autoTable({
                    startY: 45,
                    head: [details[0]],
                    body: details.slice(1),
                    theme: 'grid',
                    styles: { fontSize: 10 },
                    headStyles: { fillColor: [41, 128, 185] }
                });
                
                // Add footer
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.text(
                        `Generated on ${new Date().toLocaleString()}`,
                        doc.internal.pageSize.width / 2,
                        doc.internal.pageSize.height - 10,
                        { align: 'center' }
                    );
                }
                
                // Save the PDF
                doc.save(`medical_record_${recordId}_${new Date().toISOString().split('T')[0]}.pdf`);
            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('Error generating PDF. Please try again.');
            }
        }

        function downloadSelectedRecords() {
            try {
                const selectedCheckboxes = document.querySelectorAll('.record-checkbox:checked');
                if (selectedCheckboxes.length === 0) {
                    alert('Please select at least one record to download');
                    return;
                }

                const selectedRecords = Array.from(selectedCheckboxes).map(checkbox => {
                    const recordId = parseInt(checkbox.dataset.recordId);
                    return allRecords.find(r => r.id === recordId);
                }).filter(Boolean);

                const doc = new jsPDF();
                
                // Add title
                doc.setFontSize(16);
                doc.text('Medical Records Report', 14, 15);
                
                // Add patient info
                doc.setFontSize(12);
                doc.text(`Patient: ${document.getElementById('patientNameDisplay').textContent}`, 14, 25);
                doc.text(`Total Records: ${selectedRecords.length}`, 14, 35);
                
                // Create table data
                const tableData = selectedRecords.map(record => [
                    new Date(record.date).toLocaleDateString(),
                    record.diagnosis || 'N/A',
                    record.treatment || 'N/A',
                    record.medication || 'N/A',
                    record.doctor || 'N/A',
                    record.hospital || 'N/A'
                ]);
                
                // Add table
                doc.autoTable({
                    startY: 45,
                    head: [['Date', 'Diagnosis', 'Treatment', 'Medication', 'Doctor', 'Hospital']],
                    body: tableData,
                    theme: 'grid',
                    styles: { fontSize: 8 },
                    headStyles: { fillColor: [41, 128, 185] },
                    columnStyles: {
                        0: { cellWidth: 25 },
                        1: { cellWidth: 35 },
                        2: { cellWidth: 35 },
                        3: { cellWidth: 35 },
                        4: { cellWidth: 25 },
                        5: { cellWidth: 25 }
                    }
                });
                
                // Add footer
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.text(
                        `Generated on ${new Date().toLocaleString()}`,
                        doc.internal.pageSize.width / 2,
                        doc.internal.pageSize.height - 10,
                        { align: 'center' }
                    );
                }
                
                // Save the PDF
                doc.save(`medical_records_${new Date().toISOString().split('T')[0]}.pdf`);
            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('Error generating PDF. Please try again.');
            }
        }

        async function deleteRecord(recordId) {
            if (!window.currentPatientPIN) {
                alert('Please access your profile first before deleting records.');
                return;
            }

            if (confirm('Are you sure you want to delete this record?')) {
                try {
                    const response = await apiCall(`/api/patient/medical-records/${recordId}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({ pin: window.currentPatientPIN })
                    });
                    
                    if (response.ok) {
                        // Fetch updated records using query parameter
                        const recordsResponse = await apiCall(`/api/patient/medical-records?pin=${window.currentPatientPIN}`, {
                            method: 'GET',
                            headers: {
                                'Accept': 'application/json'
                            }
                        });
                        
                        if (recordsResponse.ok) {
                            const records = await recordsResponse.json();
                            displayRecords(records);
                            alert('Record deleted successfully!');
                        } else {
                            throw new Error('Failed to fetch updated records');
                        }
                    } else {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Failed to delete record');
                    }
                } catch (error) {
                    console.error('Error deleting record:', error);
                    alert(error.message || 'Error deleting record. Please try again.');
                }
            }
        }

        function navigateToAddPatient() {
            document.querySelector(".auth-section").style.display = "none";
            addPatientSection.style.display = "block";
        }

        const toggle = document.getElementById('menu-toggle');
        const navLinks = document.getElementById('nav-links');
        const navOverlay = document.getElementById('nav-overlay');

        toggle.addEventListener('click', () => {
            toggle.classList.toggle('active');
            navLinks.classList.toggle('active');
            navOverlay.classList.toggle('active');
            document.body.style.overflow = navLinks.classList.contains('active') ? 'hidden' : '';
        });

        // Close menu when clicking overlay
        navOverlay.addEventListener('click', () => {
            toggle.classList.remove('active');
            navLinks.classList.remove('active');
            navOverlay.classList.remove('active');
            document.body.style.overflow = '';
        });

        // Close menu when clicking on a link
        navLinks.querySelectorAll('a').forEach(link => {
            link.addEventListener('click', () => {
                toggle.classList.remove('active');
                navLinks.classList.remove('active');
                navOverlay.classList.remove('active');
                document.body.style.overflow = '';
            });
        });

        // Helper function to calculate gestational age and due date from LMP
        function calculatePregnancyDates(lmpDate) {
            if (!lmpDate) return { gestationalAge: null, dueDate: null };
            
            const lmp = new Date(lmpDate);
            const today = new Date();
            
            // Calculate gestational age
            const diffTime = Math.abs(today - lmp);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            const weeks = Math.floor(diffDays / 7);
            const days = diffDays % 7;
            const gestationalAgeText = `${weeks} weeks, ${days} days`;
            const gestationalAgeWeeks = weeks;
            
            // Calculate estimated due date (LMP + 280 days = 40 weeks)
            const dueDate = new Date(lmp);
            dueDate.setDate(dueDate.getDate() + 280);
            const dueDateFormatted = dueDate.toISOString().split('T')[0];
            
            return {
                gestationalAge: gestationalAgeText,
                gestationalAgeWeeks: gestationalAgeWeeks,
                dueDate: dueDateFormatted,
                dueDateDisplay: dueDate.toLocaleDateString()
            };
        }

        function enableProfileEdit() {
            console.log('enableProfileEdit function called');
            
            // Basic Information
            const basicFields = [
                'patientName', 'patientDob', 'patientGender',
                'patientBloodType', 'patientMaritalStatus', 'patientLanguage', 'patientNationality'
            ];

            // Contact Information
            const contactFields = [
                'patientEmail', 'patientPhone', 'patientAddress'
            ];

            // Medical Information
            const medicalFields = [
                'patientAllergies', 'patientMedications'
            ];

            // Emergency Contact
            const emergencyFields = [
                'emergencyContactName', 'emergencyContactPhone', 'emergencyContactRelationship'
            ];

            // Pregnancy Information (basic) - EXCLUDE critical fields
            const pregnancyFields = [
                'patientPregnancyStatus', 'patientPregnancyComplications'
                // Excluded: 'patientDueDate', 'patientGestationalAge' - these require individual edit
            ];

            // Pregnancy Information (detailed) - EXCLUDE critical fields
            const detailedPregnancyFields = [
                'pregnancyStatus', 'previousPregnancies', 'multiplePregnancy', 'riskLevel', 'riskFactors',
                'bloodPressure', 'hemoglobin', 'bloodSugar', 'weight',
                'prenatalVitamins', 'pregnancyComplications', 'emergencyHospital', 'birthPlan'
                // Excluded: 'lmpDate', 'dueDate', 'gestationalAge' - these require individual edit
            ];

            // Enable editing for all fields
            [...basicFields, ...contactFields, ...medicalFields, ...emergencyFields, ...pregnancyFields, ...detailedPregnancyFields].forEach(field => {
                const display = document.getElementById(field + "Display");
                const input = document.getElementById(field + "Input");
                if (display && input) {
                    console.log(`Processing field: ${field}`);
                    // For select elements, set the value
                    if (input.tagName === 'SELECT') {
                        // Try to match the display text with option text
                        const displayText = display.textContent.trim();
                        const options = input.options;
                        let found = false;
                        for (let i = 0; i < options.length; i++) {
                            if (options[i].text.toLowerCase() === displayText.toLowerCase()) {
                                input.value = options[i].value;
                                found = true;
                                break;
                            }
                        }
                        if (!found) {
                            input.value = displayText;
                        }
                    } else {
                        let displayValue = display.textContent.trim();
                        
                        // Special handling for medical measurement fields
                        if (field === 'hemoglobin' && displayValue.includes('g/dL')) {
                            // Extract just the number from "12.5 g/dL"
                            displayValue = displayValue.replace(' g/dL', '');
                        } else if (field === 'bloodSugar' && displayValue.includes('mg/dL')) {
                            // Extract just the number from "120 mg/dL"
                            displayValue = displayValue.replace(' mg/dL', '');
                        } else if (field === 'weight' && displayValue.includes('kg')) {
                            // Extract just the number from "65 kg"
                            displayValue = displayValue.replace(' kg', '');
                        }
                        // Blood pressure can stay as is (e.g., "120/80")
                        
                        input.value = displayValue;
                    }
                    display.style.display = "none";
                    input.style.display = "block";
                } else {
                    console.log(`Field not found: ${field} - display: ${!!display}, input: ${!!input}`);
                }
            });

            // Special handling for pregnancy date calculations
            const lmpInput = document.getElementById('lmpDateInput');
            if (lmpInput && lmpInput.value) {
                const pregnancyDates = calculatePregnancyDates(lmpInput.value);
                
                // Update gestational age inputs
                const gestationalAgeInput = document.getElementById('gestationalAgeInput');
                const patientGestationalAgeInput = document.getElementById('patientGestationalAgeInput');
                if (gestationalAgeInput) gestationalAgeInput.value = pregnancyDates.gestationalAgeWeeks || '';
                if (patientGestationalAgeInput) patientGestationalAgeInput.value = pregnancyDates.gestationalAgeWeeks || '';
                
                // Update due date inputs
                const dueDateInput = document.getElementById('dueDateInput');
                const patientDueDateInput = document.getElementById('patientDueDateInput');
                if (dueDateInput) dueDateInput.value = pregnancyDates.dueDate || '';
                if (patientDueDateInput) patientDueDateInput.value = pregnancyDates.dueDate || '';
            }

            // Show visual indicators for pregnancy fields being edited
            // showPregnancyEditIndicators(); // REMOVED: Pregnancy fields are now individually editable

            // CRITICAL: Do NOT automatically enable editing for these pregnancy fields
            // They should only be editable when individually clicked
            const criticalPregnancyFields = [
                'lmpDate', 'dueDate', 'gestationalAge', 
                'patientDueDate', 'patientGestationalAge'
            ];
            
            console.log('Critical pregnancy fields excluded from general edit:', criticalPregnancyFields);

            const saveBtn = document.getElementById("saveProfileBtn");
            if (saveBtn) {
                saveBtn.style.display = "inline-block";
                console.log('Save button displayed');
            } else {
                console.log('Save button not found');
            }
        }

        // Function to show visual indicators for pregnancy fields being edited
        function showPregnancyEditIndicators() {
            const criticalPregnancyFields = [
                'lmpDate', 'gestationalAge', 'dueDate', 'patientGestationalAge', 'patientDueDate'
            ];
            
            criticalPregnancyFields.forEach(field => {
                const input = document.getElementById(field + "Input");
                const display = document.getElementById(field + "Display");
                
                if (input && input.style.display !== 'none') {
                    // Add a visual indicator that this field is being edited
                    input.style.border = '2px solid #ff6b6b';
                    input.style.backgroundColor = '#fff5f5';
                    
                    // Add a small indicator text
                    const indicator = document.createElement('div');
                    indicator.id = field + 'EditIndicator';
                    indicator.style.fontSize = '12px';
                    indicator.style.color = '#ff6b6b';
                    indicator.style.marginTop = '2px';
                    indicator.style.fontWeight = 'bold';
                    indicator.textContent = '⚠️ This field is being edited';
                    
                    // Insert the indicator after the input
                    input.parentNode.insertBefore(indicator, input.nextSibling);
                    
                    console.log(`Added edit indicator for pregnancy field: ${field}`);
                }
            });
        }

        // Function to remove pregnancy edit indicators
        function removePregnancyEditIndicators() {
            const criticalPregnancyFields = [
                'lmpDate', 'gestationalAge', 'dueDate', 'patientGestationalAge', 'patientDueDate'
            ];
            
            criticalPregnancyFields.forEach(field => {
                const input = document.getElementById(field + "Input");
                const indicator = document.getElementById(field + 'EditIndicator');
                
                if (input) {
                    input.style.border = '';
                    input.style.backgroundColor = '';
                }
                
                if (indicator) {
                    indicator.remove();
                }
            });
        }

        async function saveProfileChanges() {
            try {
                // Helper function to format date for backend
                function formatDateForBackend(dateString) {
                    if (!dateString) return null;
                    
                    // If it's already in YYYY-MM-DD format, return as is
                    if (/^\d{4}-\d{2}-\d{2}$/.test(dateString)) {
                        return dateString;
                    }
                    
                    // Try to parse and format the date
                    try {
                        const date = new Date(dateString);
                        if (isNaN(date.getTime())) {
                            console.warn('Invalid date format:', dateString);
                            return null;
                        }
                        return date.toISOString().split('T')[0]; // Returns YYYY-MM-DD
                    } catch (error) {
                        console.warn('Error formatting date:', error);
                        return null;
                    }
                }

                // Helper function to handle empty values for integer fields
                function formatIntegerField(value) {
                    if (value === '' || value === null || value === undefined) {
                        return null;
                    }
                    const num = parseInt(value);
                    return isNaN(num) ? null : num;
                }

                // Helper function to handle empty values for text fields
                function formatTextField(value) {
                    if (value === '' || value === null || value === undefined) {
                        return null;
                    }
                    return value.trim();
                }

                // Helper function to get current display value if input is not visible
                function getCurrentValue(fieldName) {
                    const input = document.getElementById(fieldName + "Input");
                    const display = document.getElementById(fieldName + "Display");
                    
                    // If input is visible, use its value
                    if (input && input.style.display !== 'none') {
                        console.log(`Field ${fieldName}: Using input value - ${input.value}`);
                        return input.value;
                    }
                    // If display is visible, use its text content
                    else if (display && display.style.display !== 'none') {
                        const displayValue = display.textContent.trim();
                        console.log(`Field ${fieldName}: Using display value - ${displayValue}`);
                        return displayValue;
                    }
                    console.log(`Field ${fieldName}: No value found`);
                    return null;
                }

                // Helper function to get value only if input is visible
                function getEditedValue(fieldName) {
                    const input = document.getElementById(fieldName + "Input");
                    if (input && input.style.display !== 'none' && input.style.display !== '') {
                        const value = input.value;
                        console.log(`Field ${fieldName} is being edited with value: "${value}"`);
                        return value;
                    }
                    
                    // Check if there's an edit indicator (for pregnancy fields)
                    const indicator = document.getElementById(fieldName + 'EditIndicator');
                    if (indicator) {
                        const input = document.getElementById(fieldName + "Input");
                        if (input) {
                            const value = input.value;
                            console.log(`Field ${fieldName} has edit indicator with value: "${value}"`);
                            return value;
                        }
                    }
                    
                    console.log(`Field ${fieldName} is not being edited (input hidden or not found)`);
                    return undefined; // Not being edited
                }

                // Collect all the updated data
                const data = {
                    pin: window.currentPatientPIN,
                    // Basic Information
                    name: formatTextField(getCurrentValue('patientName')),
                    date_of_birth: formatDateForBackend(getCurrentValue('patientDob')),
                    gender: formatTextField(getCurrentValue('patientGender')),
                    blood_type: formatTextField(getCurrentValue('patientBloodType')),
                    marital_status: formatTextField(getCurrentValue('patientMaritalStatus')),
                    language: formatTextField(getCurrentValue('patientLanguage')),
                    nationality: formatTextField(getCurrentValue('patientNationality')),
                    // Contact Information
                    email: formatTextField(getCurrentValue('patientEmail')),
                    phone: formatTextField(getCurrentValue('patientPhone')),
                    address_line: formatTextField(getCurrentValue('patientAddress')),
                    // Medical Information
                    allergies: formatTextField(getCurrentValue('patientAllergies')),
                    medications: formatTextField(getCurrentValue('patientMedications')),
                    // Emergency Contact
                    emergency_contact_name: formatTextField(getCurrentValue('emergencyContactName')),
                    emergency_contact_phone: formatTextField(getCurrentValue('emergencyContactPhone')),
                    emergency_contact_relationship: formatTextField(getCurrentValue('emergencyContactRelationship')),
                };

                // Pregnancy fields: only include if being edited
                // CRITICAL: These fields should only be updated when explicitly edited by the user
                // - gestational_age: Calculated from LMP, should not change unless LMP is updated
                // - lmp_date: Last Menstrual Period, critical for pregnancy calculations
                // - due_date: Estimated due date, calculated from LMP
                const pregnancyFields = [
                    ['pregnancy_status', 'patientPregnancyStatus', formatTextField],
                    ['due_date', 'patientDueDate', formatDateForBackend],
                    ['gestational_age', 'patientGestationalAge', formatIntegerField],
                    ['pregnancy_complications', 'patientPregnancyComplications', formatTextField],
                    ['lmp_date', 'lmpDate', formatDateForBackend],
                    ['previous_pregnancies', 'previousPregnancies', formatIntegerField],
                    ['multiple_pregnancy', 'multiplePregnancy', formatTextField],
                    ['risk_level', 'riskLevel', formatTextField],
                    ['risk_factors', 'riskFactors', formatTextField],
                    ['blood_pressure', 'bloodPressure', formatTextField],
                    ['hemoglobin', 'hemoglobin', formatTextField],
                    ['blood_sugar', 'bloodSugar', formatTextField],
                    ['weight', 'weight', formatTextField],
                    ['prenatal_vitamins', 'prenatalVitamins', formatTextField],
                    ['emergency_hospital', 'emergencyHospital', formatTextField],
                    ['birth_plan', 'birthPlan', formatTextField],
                ];
                
                // Only include pregnancy fields that are actually being edited
                // This prevents unwanted updates to gestational age, LMP, and due date
                pregnancyFields.forEach(([apiField, domField, formatter]) => {
                    const editedValue = getEditedValue(domField);
                    const input = document.getElementById(domField + "Input");
                    
                    // Check if field is being edited (visible input or has edit indicator)
                    const isBeingEdited = (input && input.style.display !== 'none' && input.style.display !== '') ||
                                         document.getElementById(domField + 'EditIndicator');
                    
                    if (isBeingEdited && editedValue !== undefined && editedValue !== null && editedValue !== '') {
                        data[apiField] = formatter(editedValue);
                        console.log(`Including pregnancy field ${apiField} with value: ${editedValue}`);
                    } else {
                        console.log(`Excluding pregnancy field ${apiField} - not being edited`);
                    }
                });

                console.log('Sending profile update data:', data);

                // Send the updated data to the backend
                const response = await apiCall('/api/patient/profile', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);

                if (response.ok) {
                    const responseData = await response.json();
                    console.log('Response data:', responseData);
                    
                    // Update the display elements with the new values
                    const basicFields = [
                        'patientName', 'patientDob', 'patientGender',
                        'patientBloodType', 'patientMaritalStatus', 'patientLanguage', 'patientNationality'
                    ];

                    const contactFields = [
                        'patientEmail', 'patientPhone', 'patientAddress'
                    ];

                    const medicalFields = [
                        'patientAllergies', 'patientMedications'
                    ];

                    const emergencyFields = [
                        'emergencyContactName', 'emergencyContactPhone', 'emergencyContactRelationship'
                    ];

                    const pregnancyFields = [
                        'patientPregnancyStatus', 'patientDueDate', 'patientGestationalAge', 'patientPregnancyComplications'
                    ];

                    const detailedPregnancyFields = [
                    'pregnancyStatus', 'previousPregnancies', 'lmpDate', 'dueDate',
                    'gestationalAge', 'multiplePregnancy', 'riskLevel', 'riskFactors',
                    'bloodPressure', 'hemoglobin', 'bloodSugar', 'weight',
                    'prenatalVitamins', 'pregnancyComplications', 'emergencyHospital', 'birthPlan'
                ];

                    // Hide all input fields and show displays (will be updated by server reload)
                    [...basicFields, ...contactFields, ...medicalFields, ...emergencyFields, ...pregnancyFields, ...detailedPregnancyFields].forEach(field => {
                    const display = document.getElementById(field + "Display");
                    const input = document.getElementById(field + "Input");
                    if (display && input) {
                        display.style.display = "block";
                            input.style.display = "none";
                    }
                });

                // Remove pregnancy edit indicators
                removePregnancyEditIndicators();

                document.getElementById("saveProfileBtn").style.display = "none";
                
                // Reload patient data from server to ensure display consistency
                try {
                    console.log('Reloading patient data from server...');
                    const reloadResponse = await apiCall(`/api/patient/profile?pin=${encodeURIComponent(window.currentPatientPIN)}`, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json'
                        }
                    });
                    
                                    if (reloadResponse.ok) {
                    const reloadedData = await reloadResponse.json();
                    console.log('Reloaded data from server:', reloadedData);
                    console.log('Pregnancy data in reloaded data:', {
                        pregnancy_status: reloadedData.pregnancy_status,
                        lmp_date: reloadedData.lmp_date,
                        due_date: reloadedData.due_date,
                        gestational_age: reloadedData.gestational_age,
                        pregnancy_complications: reloadedData.pregnancy_complications
                    });
                    console.log('Medical data in reloaded data:', {
                        allergies: reloadedData.allergies,
                        medications: reloadedData.medications
                    });
                    updateProfileDisplay(reloadedData);
                    console.log('Patient data reloaded successfully');
                } else {
                    console.warn('Failed to reload patient data, but save was successful');
                    const errorText = await reloadResponse.text();
                    console.error('Reload error response:', errorText);
                }
                } catch (error) {
                    console.warn('Error reloading patient data:', error);
                }
                
                // Show detailed success message with only actually edited fields
                const editedFields = [];
                
                // Check which fields were actually being edited (had visible inputs)
                const fieldMappings = {
                    'pregnancy_status': 'Pregnancy Status',
                    'previous_pregnancies': 'Previous Pregnancies', 
                    'lmp_date': 'LMP Date',
                    'due_date': 'Due Date',
                    'gestational_age': 'Gestational Age',
                    'multiple_pregnancy': 'Multiple Pregnancy',
                    'risk_level': 'Risk Level',
                    'risk_factors': 'Risk Factors',
                    'blood_pressure': 'Blood Pressure',
                    'hemoglobin': 'Hemoglobin',
                    'blood_sugar': 'Blood Sugar',
                    'weight': 'Weight',
                    'prenatal_vitamins': 'Prenatal Vitamins',
                    'pregnancy_complications': 'Pregnancy Complications',
                    'emergency_hospital': 'Emergency Hospital',
                    'birth_plan': 'Birth Plan',
                    'name': 'Patient Name',
                    'date_of_birth': 'Date of Birth',
                    'gender': 'Gender',
                    'blood_type': 'Blood Type',
                    'marital_status': 'Marital Status',
                    'language': 'Language',
                    'nationality': 'Nationality',
                    'email': 'Email',
                    'phone': 'Phone',
                    'address_line': 'Address',
                    'allergies': 'Allergies',
                    'medications': 'Medications',
                    'emergency_contact_name': 'Emergency Contact Name',
                    'emergency_contact_phone': 'Emergency Contact Phone',
                    'emergency_contact_relationship': 'Emergency Contact Relationship'
                };
                
                // Check which fields were actually edited
                Object.keys(data).forEach(field => {
                    if (field !== 'pin' && data[field] !== undefined && data[field] !== null && data[field] !== '') {
                        const input = document.getElementById(fieldMappings[field]?.replace(/\s+/g, '') + 'Input');
                        const indicator = document.getElementById(fieldMappings[field]?.replace(/\s+/g, '') + 'EditIndicator');
                        
                        if ((input && input.style.display !== 'none') || indicator) {
                            editedFields.push(fieldMappings[field] || field);
                        }
                    }
                });
                
                // Create custom success message with better UI
                if (editedFields.length > 0) {
                    showSuccessMessage('Changes Saved Successfully!', editedFields);
                } else {
                    showSuccessMessage('Profile information updated successfully!');
                }
                } else {
                    const errorData = await response.json();
                    console.error('Error response:', errorData);
                    throw new Error(errorData.error || 'Failed to save profile changes');
                }
            } catch (error) {
                console.error('Error saving profile changes:', error);
                alert('Failed to save profile changes: ' + error.message);
            }
        }

        // Add this function to automatically update gestational age
        function updateGestationalAge() {
            const lmpDate = document.getElementById('lmpDateInput').value;
            if (lmpDate) {
                const lmp = new Date(lmpDate);
                const today = new Date();
                const diffTime = Math.abs(today - lmp);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                const weeks = Math.floor(diffDays / 7);
                const days = diffDays % 7;
                
                document.getElementById('gestationalAgeDisplay').textContent = `${weeks} weeks, ${days} days`;
            }
        }

        // Add event listener for LMP date changes
        document.getElementById('lmpDateInput').addEventListener('change', updateGestationalAge);

        // Function to set active navigation link based on current page
        function setActiveNavLink() {
            const pathname = window.location.pathname;
            let currentPage = pathname.split('/').pop() || 'index';
            
            // Handle various URL patterns
            if (currentPage === '' || currentPage === 'index' || currentPage === 'index.html') {
                currentPage = 'index';
            } else {
            currentPage = currentPage.replace('.html', '');
            }
            
            console.log('Current page detected:', currentPage);
            
            const navLinks = document.querySelectorAll('.nav-links a');
            navLinks.forEach(link => {
                link.classList.remove('active');
                let linkPage = link.getAttribute('href').replace('.html', '');
                console.log('Checking link:', linkPage, 'against current:', currentPage);
                if (linkPage === currentPage) {
                    link.classList.add('active');
                    console.log('Setting active for:', linkPage);
                }
            });
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, setting active nav link...');
            setActiveNavLink();
        });

        // Tab switching functionality
        document.addEventListener('DOMContentLoaded', function() {
            const tabBtns = document.querySelectorAll('.tab-btn');
            const tabPanes = document.querySelectorAll('.tab-pane');

            tabBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const targetTab = this.getAttribute('data-tab');
                    
                    // Remove active class from all tabs and panes
                    tabBtns.forEach(b => b.classList.remove('active'));
                    tabPanes.forEach(p => p.classList.remove('active'));
                    
                    // Add active class to clicked tab and corresponding pane
                    this.classList.add('active');
                    document.getElementById(targetTab + '-tab').classList.add('active');
                });
            });

            // Add event listener for LMP date changes
            const lmpDateInput = document.getElementById('lmpDateInput');
            if (lmpDateInput) {
                lmpDateInput.addEventListener('change', function() {
                    const gestationalAgeDisplay = document.getElementById('gestationalAgeDisplay');
                    const gestationalAgeInput = document.getElementById('gestationalAgeInput');
                    const dueDateDisplay = document.getElementById('dueDateDisplay');
                    const dueDateInput = document.getElementById('dueDateInput');
                    const patientDueDateDisplay = document.getElementById('patientDueDateDisplay');
                    const patientDueDateInput = document.getElementById('patientDueDateInput');
                    const patientGestationalAgeDisplay = document.getElementById('patientGestationalAgeDisplay');
                    const patientGestationalAgeInput = document.getElementById('patientGestationalAgeInput');
                    
                    if (this.value) {
                        const lmp = new Date(this.value);
                        const today = new Date();
                        
                        // Calculate gestational age
                        const diffTime = Math.abs(today - lmp);
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        const weeks = Math.floor(diffDays / 7);
                        const days = diffDays % 7;
                        const gestationalAgeText = `${weeks} weeks, ${days} days`;
                        const gestationalAgeWeeks = weeks;
                        
                        // Calculate estimated due date (LMP + 280 days = 40 weeks)
                        const dueDate = new Date(lmp);
                        dueDate.setDate(dueDate.getDate() + 280);
                        const dueDateFormatted = dueDate.toISOString().split('T')[0];
                        
                        // Update all gestational age displays
                        if (gestationalAgeDisplay) gestationalAgeDisplay.textContent = gestationalAgeText;
                        if (gestationalAgeInput) gestationalAgeInput.value = gestationalAgeWeeks;
                        if (patientGestationalAgeDisplay) patientGestationalAgeDisplay.textContent = gestationalAgeText;
                        if (patientGestationalAgeInput) patientGestationalAgeInput.value = gestationalAgeWeeks;
                        
                        // Update all due date displays
                        if (dueDateDisplay) dueDateDisplay.textContent = dueDate.toLocaleDateString();
                        if (dueDateInput) dueDateInput.value = dueDateFormatted;
                        if (patientDueDateDisplay) patientDueDateDisplay.textContent = dueDate.toLocaleDateString();
                        if (patientDueDateInput) patientDueDateInput.value = dueDateFormatted;
                        
                        console.log(`LMP: ${this.value}, Gestational Age: ${gestationalAgeText}, Due Date: ${dueDateFormatted}`);
                    } else {
                        // Clear all fields if LMP is empty
                        if (gestationalAgeDisplay) gestationalAgeDisplay.textContent = 'N/A';
                        if (gestationalAgeInput) gestationalAgeInput.value = '';
                        if (patientGestationalAgeDisplay) patientGestationalAgeDisplay.textContent = 'N/A';
                        if (patientGestationalAgeInput) patientGestationalAgeInput.value = '';
                        
                        if (dueDateDisplay) dueDateDisplay.textContent = 'N/A';
                        if (dueDateInput) dueDateInput.value = '';
                        if (patientDueDateDisplay) patientDueDateDisplay.textContent = 'N/A';
                        if (patientDueDateInput) patientDueDateInput.value = '';
                    }
                });
            }
        });

        // Function to update overview stats when records are loaded
        function updateOverviewStats(records) {
            const totalRecordsCount = document.getElementById('totalRecordsCount');
            const lastVisitDate = document.getElementById('lastVisitDate');
            
            if (totalRecordsCount) {
                totalRecordsCount.textContent = records.length || 0;
            }
            
            if (lastVisitDate && records.length > 0) {
                // Sort records by date and get the most recent
                const sortedRecords = records.sort((a, b) => new Date(b.date) - new Date(a.date));
                const lastRecord = sortedRecords[0];
                lastVisitDate.textContent = new Date(lastRecord.date).toLocaleDateString();
            } else if (lastVisitDate) {
                lastVisitDate.textContent = 'N/A';
            }
        }

        // Table Sorting Functionality
        let currentSortColumn = -1;
        let currentSortDirection = 'asc';

        function sortTable(columnIndex, fieldName) {
            const table = document.querySelector('table');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const headers = table.querySelectorAll('th');

            // Remove previous sort indicators
            headers.forEach(header => {
                header.classList.remove('sort-asc', 'sort-desc');
            });

            // Determine sort direction
            if (currentSortColumn === columnIndex) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortColumn = columnIndex;
                currentSortDirection = 'asc';
            }

            // Add sort indicator to current column
            headers[columnIndex].classList.add(currentSortDirection === 'asc' ? 'sort-asc' : 'sort-desc');

            // Sort the rows
            rows.sort((a, b) => {
                const aValue = getCellValue(a, columnIndex, fieldName);
                const bValue = getCellValue(b, columnIndex, fieldName);

                if (fieldName === 'date') {
                    return currentSortDirection === 'asc' 
                        ? new Date(aValue) - new Date(bValue)
                        : new Date(bValue) - new Date(aValue);
                } else {
                    if (currentSortDirection === 'asc') {
                        return aValue.localeCompare(bValue, undefined, { numeric: true, sensitivity: 'base' });
                    } else {
                        return bValue.localeCompare(aValue, undefined, { numeric: true, sensitivity: 'base' });
                    }
                }
            });

            // Reorder the rows in the table
            rows.forEach(row => tbody.appendChild(row));
        }

        function getCellValue(row, columnIndex, fieldName) {
            const cell = row.cells[columnIndex];
            if (!cell) return '';
            
            // For date fields, get the actual date value
            if (fieldName === 'date') {
                const dateText = cell.textContent.trim();
                return dateText || '';
            }
            
            // For other fields, get the text content
            return cell.textContent.trim() || '';
        }

        // Test function to verify medical measurement field handling
        function testMedicalFieldHandling() {
            console.log('Testing medical field handling...');
            
            const testFields = ['bloodPressure', 'hemoglobin', 'bloodSugar', 'weight'];
            testFields.forEach(field => {
                const display = document.getElementById(field + "Display");
                const input = document.getElementById(field + "Input");
                console.log(`${field}: Display="${display?.textContent}", Input="${input?.value}", Input visible=${input?.style.display !== 'none'}`);
            });
        }

        // Helper function to calculate gestational age and due date from LMP
        function calculateGestationalAgeFromLMP(lmpDate) {
            if (!lmpDate) return null;
            
            const lmp = new Date(lmpDate);
            const today = new Date();
            const diffTime = Math.abs(today - lmp);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            const weeks = Math.floor(diffDays / 7);
            const days = diffDays % 7;
            
            return { weeks, days, text: `${weeks} weeks, ${days} days` };
        }
        
        // Referral Feedback JavaScript Functions
        
        // Function to show/hide the referral feedback section
        function toggleFeedbackSection() {
            const section = document.getElementById('referralFeedbackSection');
            const content = document.getElementById('feedbackContent');
            const button = document.querySelector('.btn-collapse i');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                button.className = 'fas fa-chevron-up';
            } else {
                content.style.display = 'none';
                button.className = 'fas fa-chevron-down';
            }
        }
        
        // Function to show the referral feedback section when patient is loaded
        function showReferralFeedbackSection() {
            const section = document.getElementById('referralFeedbackSection');
            if (section) {
                section.style.display = 'block';
                // Auto-populate patient name
                const patientName = document.getElementById('patientNameDisplay');
                const feedbackPatientName = document.getElementById('feedbackPatientName');
                if (patientName && feedbackPatientName) {
                    feedbackPatientName.value = patientName.textContent || 'Unknown Patient';
                }
            }
        }
        
        // Function to clear the feedback form
        function clearFeedbackForm() {
            document.getElementById('feedbackNotes').value = '';
            document.getElementById('feedbackDoctorName').value = '';
            document.getElementById('feedbackDoctorPhone').value = '';
            document.getElementById('feedbackDoctorAffiliation').value = '';
            hideFeedbackMessages();
        }
        
        // Function to hide success/error messages
        function hideFeedbackMessages() {
            document.getElementById('feedbackSuccess').style.display = 'none';
            document.getElementById('feedbackError').style.display = 'none';
        }
        
        // Function to show success message
        function showFeedbackSuccess(data) {
            const successDiv = document.getElementById('feedbackSuccess');
            const timestampSpan = document.getElementById('feedbackTimestamp');
            const smsStatusSpan = document.getElementById('smsStatus');
            
            timestampSpan.textContent = `Submitted: ${data.timestamp}`;
            smsStatusSpan.textContent = `SMS: ${data.sms_sent ? 'Sent' : 'Not sent'}`;
            
            successDiv.style.display = 'block';
            document.getElementById('feedbackError').style.display = 'none';
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 5000);
        }
        
        // Function to show error message
        function showFeedbackError(message) {
            const errorDiv = document.getElementById('feedbackError');
            const errorMessage = document.getElementById('errorMessage');
            
            errorMessage.textContent = message;
            errorDiv.style.display = 'block';
            document.getElementById('feedbackSuccess').style.display = 'none';
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }
        
        // Function to submit referral feedback
        async function submitReferralFeedback(event) {
            event.preventDefault();
            
            const form = event.target;
            const formData = new FormData(form);
            
            // Get the current patient PIN
            const patientPin = window.currentPatientPIN;
            if (!patientPin) {
                showFeedbackError('Patient PIN not found. Please reload the page.');
                return;
            }
            
            // Prepare the data
            const feedbackData = {
                patient_name: formData.get('patient_name'),
                referral_source: formData.get('referral_source'),
                doctor_name: formData.get('doctor_name'),
                doctor_phone: formData.get('doctor_phone'),
                doctor_affiliation: formData.get('doctor_affiliation'),
                feedback_notes: formData.get('feedback_notes'),
                patient_pin: patientPin
            };
            
            try {
                // Show loading state
                const submitButton = form.querySelector('button[type="submit"]');
                const originalText = submitButton.innerHTML;
                submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
                submitButton.disabled = true;
                
                // Submit the feedback
                const response = await apiCall(`/api/referral-feedback?pin=${encodeURIComponent(patientPin)}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(feedbackData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showFeedbackSuccess(result);
                    form.reset();
                    // Re-populate the patient name
                    document.getElementById('feedbackPatientName').value = feedbackData.patient_name;
                } else {
                    showFeedbackError(result.error || 'Failed to submit feedback');
                }
                
            } catch (error) {
                console.error('Error submitting feedback:', error);
                showFeedbackError('Network error. Please check your connection and try again.');
            } finally {
                // Restore button state
                const submitButton = form.querySelector('button[type="submit"]');
                submitButton.innerHTML = '<i class="fas fa-paper-plane"></i> Submit Feedback';
                submitButton.disabled = false;
            }
        }
        
        // Add event listener for the feedback form
        document.addEventListener('DOMContentLoaded', function() {
            const feedbackForm = document.getElementById('referralFeedbackForm');
            if (feedbackForm) {
                feedbackForm.addEventListener('submit', submitReferralFeedback);
            }
        });
        
        // Override the existing updateProfileDisplay function to show feedback section
        const originalUpdateProfileDisplay = window.updateProfileDisplay;
        window.updateProfileDisplay = function(profile) {
            // Call the original function
            if (originalUpdateProfileDisplay) {
                originalUpdateProfileDisplay(profile);
            }
            
            // Show the referral feedback section and populate patient name
            const feedbackSection = document.getElementById('referralFeedbackSection');
            const patientNameInput = document.getElementById('feedbackPatientName');
            
            if (feedbackSection && patientNameInput) {
                feedbackSection.style.display = 'block';
                patientNameInput.value = profile.name || 'Unknown Patient';
            }
        };

        // Logout function
        function logout() {
            if (confirm('Are you sure you want to logout? You will need to enter your PIN again to access your records.')) {
                // Clear the stored PIN
                window.currentPatientPIN = null;
                
                // Hide the medical records section
                document.getElementById('medicalRecords').style.display = 'none';
                
                // Show the auth section
                document.querySelector('.auth-section').style.display = 'block';
                
                // Clear the PIN input
                document.getElementById('patientPin').value = '';
                
                // Clear any error messages
                document.getElementById('pinError').style.display = 'none';
                
                // Reset the form
                document.getElementById('pinForm').reset();
                
                // Clear any displayed data
                clearDisplayedData();
                
                console.log('User logged out successfully');
            }
        }

        // Function to clear displayed data
        function clearDisplayedData() {
            // Clear all display elements
            const displayElements = [
                'patientNameDisplay', 'patientIdDisplay', 'patientFhirIdDisplay',
                'patientDobDisplay', 'patientGenderDisplay', 'patientBloodTypeDisplay',
                'patientMaritalStatusDisplay', 'patientLanguageDisplay', 'patientNationalityDisplay',
                'patientEmailDisplay', 'patientPhoneDisplay', 'patientAddressDisplay',
                'emergencyContactNameDisplay', 'emergencyContactPhoneDisplay', 'emergencyContactRelationshipDisplay',
                'patientAllergiesDisplay', 'patientMedicationsDisplay',
                'patientPregnancyStatusDisplay', 'patientDueDateDisplay', 'patientGestationalAgeDisplay',
                'patientPregnancyComplicationsDisplay'
            ];
            
            displayElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = '';
                }
            });
            
            // Clear the records table
            const recordsTableBody = document.getElementById('recordsTableBody');
            if (recordsTableBody) {
                recordsTableBody.innerHTML = '';
            }
            
            // Reset overview stats
            const statsElements = ['totalRecordsCount', 'lastVisitDate', 'pregnancyStatus', 'bloodTypeDisplay'];
            statsElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = 'N/A';
                }
            });
        }

        // Add event listeners for profile buttons
        document.addEventListener('DOMContentLoaded', function() {
            // Edit button
            const editBtn = document.querySelector('.btn-edit');
            if (editBtn) {
                editBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('Edit button clicked via event listener');
                    enableProfileEdit();
                });
            }

            // Logout button
            const logoutBtn = document.querySelector('.btn-logout');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('Logout button clicked via event listener');
                    logout();
                });
            }

            // Save button
            const saveBtn = document.getElementById('saveProfileBtn');
            if (saveBtn) {
                saveBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('Save button clicked via event listener');
                    saveProfileChanges();
                });
            }
        });



        // Confirmation function for critical pregnancy fields
        function confirmPregnancyFieldEdit(fieldName) {
            const fieldLabels = {
                'patientDueDate': 'Estimated Due Date',
                'patientGestationalAge': 'Gestational Age',
                'lmpDate': 'Last Menstrual Period',
                'dueDate': 'Estimated Due Date',
                'gestationalAge': 'Gestational Age'
            };
            
            const fieldLabel = fieldLabels[fieldName] || fieldName;
            
            const confirmed = confirm(`Do you want to edit the ${fieldLabel}?\n\nThis is a critical pregnancy field. Please ensure the information is accurate.`);
            
            if (confirmed) {
                enableIndividualPregnancyFieldEdit(fieldName);
            }
        }

        // Individual edit functions for critical pregnancy fields
        function enableIndividualPregnancyFieldEdit(fieldName) {
            console.log(`Enabling individual edit for pregnancy field: ${fieldName}`);
            
            const display = document.getElementById(fieldName + "Display");
            const input = document.getElementById(fieldName + "Input");
            
            if (display && input) {
                // Set the input value from display
                let displayValue = display.textContent.trim();
                
                // Special handling for gestational age (remove "weeks, X days" format)
                if (fieldName === 'gestationalAge' || fieldName === 'patientGestationalAge') {
                    if (displayValue.includes('weeks')) {
                        displayValue = displayValue.split(' ')[0]; // Extract just the number
                    }
                }
                
                input.value = displayValue;
                
                // Hide display and show input
                display.style.display = "none";
                input.style.display = "block";
                
                // Add visual indicator
                input.style.border = '2px solid #ff6b6b';
                input.style.backgroundColor = '#fff5f5';
                
                // Add indicator text
                const indicator = document.createElement('div');
                indicator.id = fieldName + 'EditIndicator';
                indicator.style.fontSize = '12px';
                indicator.style.color = '#ff6b6b';
                indicator.style.marginTop = '2px';
                indicator.style.fontWeight = 'bold';
                indicator.textContent = '⚠️ This field is being edited';
                
                // Insert the indicator after the input
                input.parentNode.insertBefore(indicator, input.nextSibling);
                
                // Show save button if not already visible
                const saveBtn = document.getElementById("saveProfileBtn");
                if (saveBtn && saveBtn.style.display === 'none') {
                    saveBtn.style.display = "inline-block";
                }
                
                console.log(`Individual edit enabled for: ${fieldName}`);
            } else {
                console.log(`Field not found for individual edit: ${fieldName}`);
            }
        }
    </script>

    <!-- Referral Feedback Section -->
    <section class="referral-feedback-section" id="referralFeedbackSection" style="display: none;">
        <div class="feedback-container">
            <div class="feedback-header">
                <div class="section-header">
                    <i class="fas fa-comment-medical"></i>
                    <h2>Referral Feedback</h2>
                </div>
                <button class="btn-collapse" onclick="toggleFeedbackSection()">
                    <i class="fas fa-chevron-up"></i>
                </button>
            </div>
            
            <div class="feedback-content" id="feedbackContent">
                <div class="feedback-info">
                    <p><i class="fas fa-info-circle"></i> Submit feedback about this patient's referral to Prestrack. This will be sent via SMS and logged in our system.</p>
                </div>
                
                <form id="referralFeedbackForm" class="feedback-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="feedbackPatientName">
                                <i class="fas fa-user"></i>
                                Patient Name
                            </label>
                            <input type="text" id="feedbackPatientName" name="patient_name" class="form-control" readonly>
                        </div>

                        <div class="form-group">
                            <label for="feedbackReferralSource">
                                <i class="fas fa-share-alt"></i>
                                Referral Source
                            </label>
                            <input type="text" id="feedbackReferralSource" name="referral_source" class="form-control" value="PresTrack" readonly>
                        </div>

                        <div class="form-group">
                            <label for="feedbackDoctorName">
                                <i class="fas fa-user-md"></i>
                                Doctor's Name
                            </label>
                            <input type="text" id="feedbackDoctorName" name="doctor_name" class="form-control" 
                                   placeholder="Enter doctor's full name" required>
                        </div>

                        <div class="form-group">
                            <label for="feedbackDoctorPhone">
                                <i class="fas fa-phone"></i>
                                Doctor's Phone Number
                            </label>
                            <input type="tel" id="feedbackDoctorPhone" name="doctor_phone" class="form-control" 
                                   placeholder="Enter doctor's phone number" required>
                        </div>

                        <div class="form-group">
                            <label for="feedbackDoctorAffiliation">
                                <i class="fas fa-hospital"></i>
                                Doctor's Affiliation
                            </label>
                            <input type="text" id="feedbackDoctorAffiliation" name="doctor_affiliation" class="form-control" 
                                   placeholder="Enter hospital or clinic name" required>
                        </div>

                        <div class="form-group full-width">
                            <label for="feedbackNotes">
                                <i class="fas fa-edit"></i>
                                Feedback Notes
                            </label>
                            <textarea id="feedbackNotes" name="feedback_notes" class="form-control" 
                                      placeholder="Enter your feedback about the patient's referral, treatment progress, or any important notes..." 
                                      rows="4" required></textarea>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn-primary">
                            <i class="fas fa-paper-plane"></i>
                            Submit Feedback
                        </button>
                        <button type="button" class="btn-secondary" onclick="clearFeedbackForm()">
                            <i class="fas fa-times"></i>
                            Clear
                        </button>
                    </div>
                </form>

                <div id="feedbackSuccess" class="feedback-success" style="display: none;">
                    <div class="success-content">
                        <i class="fas fa-check-circle"></i>
                        <h3>Feedback Submitted Successfully!</h3>
                        <p>Your referral feedback has been sent and logged in our system.</p>
                    </div>
                </div>

                <div id="feedbackError" class="feedback-error" style="display: none;">
                    <div class="error-content">
                        <i class="fas fa-exclamation-circle"></i>
                        <h3>Error Submitting Feedback</h3>
                        <p id="feedbackErrorMessage">Please try again later.</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

</body>
</html>