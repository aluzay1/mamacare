<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pregnancy Tracker - MamaCare</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        .pregnancy-tracker {
            padding: 80px 20px;
            background: #f8f9fa;
        }

        .tracker-container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            padding: 0 20px;
        }

        .tracker-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .tracker-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .tracker-card h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .tracker-card i {
            font-size: 2rem;
            color: #007bff;
            margin-bottom: 15px;
        }

        .tracker-form {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            margin-top: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #2c3e50;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }

        .btn-track {
            background: #007bff;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .btn-track:hover {
            background: #0056b3;
        }

        .progress-section {
            margin-top: 40px;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: #28a745;
            transition: width 0.3s ease;
        }

        .milestone-list {
            list-style: none;
            padding: 0;
        }

        .milestone-item {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .milestone-item i {
            margin-right: 10px;
            color: #28a745;
        }

        .milestone-item.completed {
            background: #e8f5e9;
        }

        .login-section {
            max-width: 400px;
            margin: 0 auto;
            padding: 30px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        .login-section h2 {
            text-align: center;
            margin-bottom: 30px;
            color: #2c3e50;
        }

        .reminder-section {
            margin-top: 40px;
        }

        .reminder-list {
            list-style: none;
            padding: 0;
        }

        .reminder-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: white;
            border-radius: 5px;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .reminder-item i {
            color: #dc3545;
            cursor: pointer;
        }

        .export-section {
            margin-top: 40px;
            text-align: center;
        }

        .export-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 20px;
        }

        .btn-export {
            background: #28a745;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .btn-export:hover {
            background: #218838;
        }
    </style>
</head>
<body>
    <header>
        <nav class="navbar">
            <div class="logo">MamaCare</div>
            <ul class="nav-links">
                <li><a href="index.html">Home</a></li>
                <li><a href="dashboard.html">Dashboard</a></li>
                <li><a href="doctors.html">Doctors</a></li>
                <li><a href="hospitals.html">Hospitals</a></li>
                <li><a href="medical_records.html">Medical Records</a></li>
                <li><a href="pregnancy_tracker.html" class="active">Pregnancy Tracker</a></li>
                <li><a href="pharmacy.html">Pharmacy</a></li>
                <li><a href="crowdfunding.html">Crowdfunding</a></li>
                <li><a href="campaign_management.html">Campaign Management</a></li>
            </ul>
        </nav>
    </header>

    <section class="pregnancy-tracker">
        <h2 style="text-align: center; font-size: 2.5rem; margin-bottom: 50px; color: #2c3e50;">Pregnancy Tracker</h2>
        
        <!-- Login Section -->
        <div id="loginSection" class="login-section">
            <h2>Access Your Tracker</h2>
            <div class="form-group">
                <label for="pin">Enter your PIN</label>
                <input type="password" id="pin" name="pin" maxlength="6" required>
                <p style="font-size: 0.9em; color: #666; margin-top: 5px;">Enter the 6-digit PIN sent to your email</p>
            </div>
            <button class="btn-track" onclick="login()">Access Tracker</button>
            <p style="text-align: center; margin-top: 20px;">
                <a href="#" onclick="showRegistration()">New user? Register here</a>
            </p>
        </div>

        <!-- Registration Section -->
        <div id="registrationSection" class="login-section" style="display: none;">
            <h2>Register for Pregnancy Tracker</h2>
            <div class="form-group">
                <label for="regName">Full Name</label>
                <input type="text" id="regName" name="regName" required>
            </div>
            <div class="form-group">
                <label for="regEmail">Email</label>
                <input type="email" id="regEmail" name="regEmail" required>
            </div>
            <div class="form-group">
                <label for="regPhone">Phone Number</label>
                <input type="tel" id="regPhone" name="regPhone" required>
            </div>
            <div class="form-group">
                <label for="regDob">Date of Birth</label>
                <input type="date" id="regDob" name="regDob" required>
            </div>
            <div class="form-group">
                <label for="regAddress">Address</label>
                <textarea id="regAddress" name="regAddress" rows="2" required></textarea>
            </div>
            <div class="form-group">
                <label for="regEmergencyContact">Emergency Contact Name</label>
                <input type="text" id="regEmergencyContact" name="regEmergencyContact" required>
            </div>
            <div class="form-group">
                <label for="regEmergencyPhone">Emergency Contact Phone</label>
                <input type="tel" id="regEmergencyPhone" name="regEmergencyPhone" required>
            </div>
            <div class="form-group">
                <label for="regBloodType">Blood Type</label>
                <select id="regBloodType" name="regBloodType" required>
                    <option value="">Select Blood Type</option>
                    <option value="A+">A+</option>
                    <option value="A-">A-</option>
                    <option value="B+">B+</option>
                    <option value="B-">B-</option>
                    <option value="AB+">AB+</option>
                    <option value="AB-">AB-</option>
                    <option value="O+">O+</option>
                    <option value="O-">O-</option>
                </select>
            </div>
            <div class="form-group">
                <label for="regAllergies">Allergies (if any)</label>
                <textarea id="regAllergies" name="regAllergies" rows="2"></textarea>
            </div>
            <button class="btn-track" onclick="register()">Register</button>
            <p style="text-align: center; margin-top: 20px;">
                <a href="#" onclick="showLogin()">Already registered? Login here</a>
            </p>
        </div>

        <!-- Main Tracker Section -->
        <div id="trackerSection" style="display: none;">
            <div class="tracker-container">
                <div class="tracker-card">
                    <i class="fas fa-calendar-alt"></i>
                    <h3>Due Date Calculator</h3>
                    <div class="form-group">
                        <label for="lmp">Last Menstrual Period (LMP)</label>
                        <input type="date" id="lmp" name="lmp">
                    </div>
                    <div class="form-group">
                        <label for="cycle-length">Average Cycle Length (days)</label>
                        <input type="number" id="cycle-length" name="cycle-length" value="28">
                    </div>
                    <button class="btn-track" onclick="calculateDueDate()">Calculate Due Date</button>
                    <div id="due-date-result" style="margin-top: 20px; font-weight: bold;"></div>
                </div>

                <div class="tracker-card">
                    <i class="fas fa-weight"></i>
                    <h3>Weight Tracker</h3>
                    <div class="form-group">
                        <label for="current-weight">Current Weight (kg)</label>
                        <input type="number" id="current-weight" name="current-weight" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="pre-pregnancy-weight">Pre-pregnancy Weight (kg)</label>
                        <input type="number" id="pre-pregnancy-weight" name="pre-pregnancy-weight" step="0.1">
                    </div>
                    <button class="btn-track" onclick="trackWeight()">Track Weight</button>
                    <div id="weight-result" style="margin-top: 20px;"></div>
                </div>

                <div class="tracker-card">
                    <i class="fas fa-heartbeat"></i>
                    <h3>Health Metrics</h3>
                    <div class="form-group">
                        <label for="blood-pressure">Blood Pressure</label>
                        <input type="text" id="blood-pressure" name="blood-pressure" placeholder="e.g., 120/80">
                    </div>
                    <div class="form-group">
                        <label for="symptoms">Symptoms</label>
                        <textarea id="symptoms" name="symptoms" rows="3"></textarea>
                    </div>
                    <button class="btn-track" onclick="trackHealth()">Track Health</button>
                </div>
            </div>

            <div class="progress-section">
                <h3 style="text-align: center; margin-bottom: 30px;">Pregnancy Progress</h3>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 0%"></div>
                </div>
                <ul class="milestone-list">
                    <li class="milestone-item">
                        <i class="fas fa-check-circle"></i>
                        <span>First Trimester (Weeks 1-12)</span>
                    </li>
                    <li class="milestone-item">
                        <i class="fas fa-check-circle"></i>
                        <span>Second Trimester (Weeks 13-26)</span>
                    </li>
                    <li class="milestone-item">
                        <i class="fas fa-circle"></i>
                        <span>Third Trimester (Weeks 27-40)</span>
                    </li>
                </ul>
            </div>

            <div class="reminder-section">
                <h3 style="text-align: center; margin-bottom: 30px;">Appointment Reminders</h3>
                <div class="form-group">
                    <label for="reminder-date">Appointment Date</label>
                    <input type="datetime-local" id="reminder-date" name="reminder-date">
                </div>
                <div class="form-group">
                    <label for="reminder-notes">Notes</label>
                    <textarea id="reminder-notes" name="reminder-notes" rows="2"></textarea>
                </div>
                <button class="btn-track" onclick="addReminder()">Add Reminder</button>
                <ul id="reminder-list" class="reminder-list"></ul>
            </div>

            <div class="export-section">
                <h3>Export Your Data</h3>
                <p>Share your pregnancy data with your healthcare provider</p>
                <div class="export-buttons">
                    <button class="btn-export" onclick="exportToPDF()">Export as PDF</button>
                    <button class="btn-export" onclick="exportToCSV()">Export as CSV</button>
                </div>
            </div>
        </div>
    </section>

    <footer>
        <p>&copy; 2024 MamaCare. All rights reserved.</p>
    </footer>

    <script>
        // API Configuration
        const API_BASE_URL = 'http://localhost:5000/api/pregnancy';
        let currentUser = null;

        // Login and Registration Functions
        function showRegistration() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('registrationSection').style.display = 'block';
        }

        function showLogin() {
            document.getElementById('registrationSection').style.display = 'none';
            document.getElementById('loginSection').style.display = 'block';
        }

        async function login() {
            const pin = document.getElementById('pin').value;
            
            try {
                const response = await fetch(`${API_BASE_URL}/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ pin })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    currentUser = data.user;
                    document.getElementById('loginSection').style.display = 'none';
                    document.getElementById('trackerSection').style.display = 'block';
                    loadUserData();
                } else {
                    alert(data.error || 'Login failed');
                }
            } catch (error) {
                console.error('Login error:', error);
                alert('An error occurred during login');
            }
        }

        async function register() {
            try {
                const name = document.getElementById('regName').value;
                const email = document.getElementById('regEmail').value;
                const phone = document.getElementById('regPhone').value;
                const dob = document.getElementById('regDob').value;
                const address = document.getElementById('regAddress').value;
                const emergencyContact = document.getElementById('regEmergencyContact').value;
                const emergencyPhone = document.getElementById('regEmergencyPhone').value;
                const bloodType = document.getElementById('regBloodType').value;
                const allergies = document.getElementById('regAllergies').value;
                
                // Validate required fields
                if (!name || !email || !phone || !dob || !address || !emergencyContact || !emergencyPhone || !bloodType) {
                    alert('Please fill in all required fields');
                    return;
                }
                
                // Validate email format
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    alert('Please enter a valid email address');
                    return;
                }
                
                // Validate phone number format (basic validation)
                const phoneRegex = /^\+?[\d\s-]{10,}$/;
                if (!phoneRegex.test(phone)) {
                    alert('Please enter a valid phone number');
                    return;
                }
                
                console.log('Sending registration data:', {
                    name,
                    email,
                    phone,
                    date_of_birth: dob,
                    address,
                    emergency_contact_name: emergencyContact,
                    emergency_contact_phone: emergencyPhone,
                    blood_type: bloodType,
                    allergies
                });
                
                const response = await fetch(`${API_BASE_URL}/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name,
                        email,
                        phone,
                        date_of_birth: dob,
                        address,
                        emergency_contact_name: emergencyContact,
                        emergency_contact_phone: emergencyPhone,
                        blood_type: bloodType,
                        allergies
                    })
                });
                
                const data = await response.json();
                console.log('Registration response:', data);  // Debug log
                
                if (response.ok) {
                    alert(data.message);
                    if (data.pin) {
                        alert(`Your PIN is: ${data.pin}\nPlease save this PIN as it will be needed to access your account.`);
                    }
                    showLogin();
                } else {
                    if (data.missing_fields) {
                        alert(`Missing required fields: ${data.missing_fields.join(', ')}`);
                    } else if (data.error) {
                        alert(`Registration failed: ${data.error}`);
                        if (data.details) {
                            console.error('Error details:', data.details);
                        }
                    } else {
                        alert('Registration failed. Please try again.');
                    }
                }
            } catch (error) {
                console.error('Registration error:', error);
                alert('An error occurred during registration. Please check if the server is running and try again.');
            }
        }

        // Data Loading Functions
        async function loadUserData() {
            try {
                const response = await fetch(`${API_BASE_URL}/data?user_id=${currentUser.id}`);
                const data = await response.json();
                
                if (response.ok) {
                    // Update form fields with existing data
                    if (data.lmp) document.getElementById('lmp').value = data.lmp;
                    if (data.weight) document.getElementById('current-weight').value = data.weight;
                    if (data.blood_pressure) document.getElementById('blood-pressure').value = data.blood_pressure;
                    if (data.symptoms) document.getElementById('symptoms').value = data.symptoms;
                    
                    // Update progress bar and milestones
                    updateProgress(data.current_week);
                }
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        async function loadReminders() {
            try {
                const response = await fetch(`${API_BASE_URL}/reminders?user_id=${currentUser.id}`);
                const reminders = await response.json();
                
                if (response.ok) {
                    const reminderList = document.getElementById('reminder-list');
                    reminderList.innerHTML = '';
                    
                    reminders.forEach(reminder => {
                        const reminderItem = document.createElement('li');
                        reminderItem.className = 'reminder-item';
                        reminderItem.innerHTML = `
                            <div>
                                <strong>${new Date(reminder.date).toLocaleString()}</strong>
                                <p>${reminder.notes}</p>
                            </div>
                            <i class="fas fa-trash" onclick="deleteReminder(${reminder.id})"></i>
                        `;
                        reminderList.appendChild(reminderItem);
                    });
                }
            } catch (error) {
                console.error('Error loading reminders:', error);
            }
        }

        // Tracker Functions
        async function calculateDueDate() {
            const lmp = new Date(document.getElementById('lmp').value);
            const cycleLength = parseInt(document.getElementById('cycle-length').value);
            
            // Add 280 days (40 weeks) to LMP
            const dueDate = new Date(lmp);
            dueDate.setDate(dueDate.getDate() + 280);
            
            document.getElementById('due-date-result').innerHTML = 
                `Estimated Due Date: ${dueDate.toLocaleDateString()}`;
            
            // Save to backend
            try {
                const response = await fetch(`${API_BASE_URL}/data`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user_id: currentUser.id,
                        lmp: lmp.toISOString().split('T')[0],
                        due_date: dueDate.toISOString().split('T')[0],
                        current_week: Math.floor((new Date() - lmp) / (7 * 24 * 60 * 60 * 1000))
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to save due date');
                }
            } catch (error) {
                console.error('Error saving due date:', error);
            }
        }

        async function trackWeight() {
            const currentWeight = parseFloat(document.getElementById('current-weight').value);
            const prePregnancyWeight = parseFloat(document.getElementById('pre-pregnancy-weight').value);
            
            if (currentWeight && prePregnancyWeight) {
                const weightGain = currentWeight - prePregnancyWeight;
                document.getElementById('weight-result').innerHTML = 
                    `Weight Gain: ${weightGain.toFixed(1)} kg`;
                
                // Save to backend
                try {
                    const response = await fetch(`${API_BASE_URL}/data`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            user_id: currentUser.id,
                            weight: currentWeight
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to save weight');
                    }
                } catch (error) {
                    console.error('Error saving weight:', error);
                }
            }
        }

        async function trackHealth() {
            const bloodPressure = document.getElementById('blood-pressure').value;
            const symptoms = document.getElementById('symptoms').value;
            
            try {
                const response = await fetch(`${API_BASE_URL}/data`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user_id: currentUser.id,
                        blood_pressure: bloodPressure,
                        symptoms: symptoms
                    })
                });
                
                if (response.ok) {
                    alert('Health metrics saved successfully!');
                } else {
                    throw new Error('Failed to save health metrics');
                }
            } catch (error) {
                console.error('Error saving health metrics:', error);
                alert('Failed to save health metrics');
            }
        }

        async function addReminder() {
            const date = document.getElementById('reminder-date').value;
            const notes = document.getElementById('reminder-notes').value;
            
            if (date && notes) {
                try {
                    const response = await fetch(`${API_BASE_URL}/reminders`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            user_id: currentUser.id,
                            date: date,
                            notes: notes
                        })
                    });
                    
                    if (response.ok) {
                        // Clear the form
                        document.getElementById('reminder-date').value = '';
                        document.getElementById('reminder-notes').value = '';
                        loadReminders(); // Reload reminders list
                    } else {
                        throw new Error('Failed to add reminder');
                    }
                } catch (error) {
                    console.error('Error adding reminder:', error);
                    alert('Failed to add reminder');
                }
            }
        }

        async function deleteReminder(reminderId) {
            try {
                const response = await fetch(`${API_BASE_URL}/reminders/${reminderId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    loadReminders(); // Reload reminders list
                } else {
                    throw new Error('Failed to delete reminder');
                }
            } catch (error) {
                console.error('Error deleting reminder:', error);
                alert('Failed to delete reminder');
            }
        }

        async function exportToPDF() {
            try {
                const response = await fetch(`${API_BASE_URL}/export`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user_id: currentUser.id,
                        data_type: 'PDF'
                    })
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'pregnancy_data.pdf';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    throw new Error('Failed to export data');
                }
            } catch (error) {
                console.error('Error exporting data:', error);
                alert('Failed to export data');
            }
        }

        async function exportToCSV() {
            try {
                const response = await fetch(`${API_BASE_URL}/export`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user_id: currentUser.id,
                        data_type: 'CSV'
                    })
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'pregnancy_data.csv';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    throw new Error('Failed to export data');
                }
            } catch (error) {
                console.error('Error exporting data:', error);
                alert('Failed to export data');
            }
        }

        // Helper Functions
        function updateProgress(currentWeek) {
            const progressFill = document.querySelector('.progress-fill');
            const milestoneItems = document.querySelectorAll('.milestone-item');
            
            // Update progress bar
            const progress = (currentWeek / 40) * 100;
            progressFill.style.width = `${Math.min(progress, 100)}%`;
            
            // Update milestones
            milestoneItems.forEach(item => {
                const text = item.querySelector('span').textContent;
                if (text.includes('First Trimester') && currentWeek >= 12) {
                    item.classList.add('completed');
                } else if (text.includes('Second Trimester') && currentWeek >= 26) {
                    item.classList.add('completed');
                } else if (text.includes('Third Trimester') && currentWeek >= 40) {
                    item.classList.add('completed');
                }
            });
        }
    </script>
</body>
</html> 